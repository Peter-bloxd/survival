<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå­˜æ³•åˆ™ Â· SURVIVAL RULES</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon: #00f2ff; 
            --bg: #020508; 
            --card: rgba(10, 20, 30, 0.85); 
            --border: rgba(0, 242, 255, 0.3); 
            --admin: #ff0055; 
            --gold: #ffd700; 
        }
        body { 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Noto Sans SC', sans-serif; 
            margin: 0; 
            background-image: radial-gradient(circle at 50% 50%, #0a1a1a 0%, var(--bg) 80%); 
            min-height: 100vh; 
            overflow-x: hidden; 
        }
        
        /* å¯¼èˆªæ  */
        nav { 
            background: rgba(5, 10, 15, 0.9); 
            backdrop-filter: blur(15px); 
            border-bottom: 2px solid var(--border); 
            padding: 15px 40px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
        }
        .logo { 
            display: flex; 
            align-items: center; 
            text-decoration: none; 
            color: #fff; 
            font-family: 'Orbitron'; 
            font-weight: bold; 
        }
        .logo img { 
            height: 32px; 
            width: 32px; 
            margin-right: 10px; 
            border-radius: 4px; 
        }
        .logo span { 
            color: var(--neon); 
            text-shadow: 0 0 10px var(--neon); 
        }

        /* ä¸»ä½“å¸ƒå±€ */
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 60px 20px; 
            text-align: center; 
        }
        h1 { 
            font-family: 'Orbitron'; 
            font-size: 50px; 
            text-shadow: 0 0 20px var(--neon); 
            margin: 0; 
        }
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); 
            gap: 20px; 
            margin-top: 40px; 
        }
        
        /* åŠŸèƒ½å¡ç‰‡ */
        .card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            padding: 35px 20px; 
            transition: 0.3s; 
            cursor: pointer; 
            position: relative; 
            overflow: hidden;
        }
        .card:hover { 
            border-color: var(--neon); 
            transform: translateY(-5px); 
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.2); 
        }
        .card h3 { 
            color: var(--neon); 
            margin: 10px 0; 
            font-family: 'Orbitron'; 
        }
        .card.admin-only { 
            border-color: var(--admin); 
            display: none; 
        }
        .card.admin-only h3 { 
            color: var(--admin); 
        }

        /* å¼¹çª—ç³»ç»Ÿ */
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.95); 
            z-index: 2000; 
            backdrop-filter: blur(10px); 
        }
        .modal-content { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            background: #0a0f14; 
            border: 2px solid var(--neon); 
            padding: 30px; 
            width: 450px; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 8px 0; 
            background: #000; 
            border: 1px solid #333; 
            color: var(--neon); 
            box-sizing: border-box; 
        }
        .btn { 
            width: 100%; 
            padding: 12px; 
            background: transparent; 
            color: var(--neon); 
            border: 1px solid var(--neon); 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 10px; 
            transition: 0.3s; 
        }
        .btn:hover { 
            background: var(--neon); 
            color: #000; 
        }

        /* æ’è¡Œæ¦œè¡Œ */
        .lb-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px; 
            background: rgba(255,255,255,0.05); 
            margin-bottom: 5px; 
            border-left: 4px solid var(--neon); 
        }
        .lb-row.top3 { 
            border-left-color: var(--gold); 
            background: rgba(255, 215, 0, 0.1); 
        }
        
        /* èŠå¤©ç³»ç»Ÿ */
        #chat-window, #p-chat-window { 
            display: none; 
            position: fixed; 
            bottom: 30px; 
            right: 30px; 
            width: 350px; 
            height: 500px; 
            background: #0a0f14; 
            border: 1px solid var(--neon); 
            flex-direction: column; 
            z-index: 3000; 
        }
        #chat-msgs, #p-chat-msgs { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .msg { 
            background: rgba(0,242,255,0.05); 
            padding: 10px; 
            border-left: 3px solid var(--neon); 
        }
        .msg b { 
            color: var(--neon); 
            display: block; 
            font-size: 11px; 
        }

        /* æ‰“å¡ç½‘æ ¼ */
        .check-grid { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 10px; 
            margin-top: 15px; 
        }
        .day-box { 
            background: #000; 
            border: 1px solid #333; 
            padding: 10px; 
            font-size: 10px; 
            text-align: center; 
            opacity: 0.5; 
        }
        .day-box.active { 
            border-color: var(--neon); 
            opacity: 1; 
        }
        .day-box.claimed { 
            background: var(--neon); 
            color: #000; 
            opacity: 1; 
        }
        
        .staff-item, .f-item { 
            background: rgba(255,255,255,0.05); 
            padding: 15px; 
            border-radius: 4px; 
            margin-bottom: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-left: 4px solid var(--neon); 
        }
        .comment-box { 
            margin-top: 8px; 
            padding: 8px; 
            background: #000; 
            font-size: 12px; 
            border: 1px solid #222; 
        }
    </style>
</head>
<body>

<nav>
    <a href="#" class="logo">
        <img src="ç”Ÿå­˜æ³•åˆ™å›¾æ ‡.jpg">
        ç”Ÿå­˜æ³•åˆ™ Â· <span>RULES</span>
    </a>
    <div id="auth-ui"></div>
</nav>

<div class="container">
    <h1>SURVIVAL HUB</h1>
    <p style="color: var(--neon); opacity: 0.6;">SYSTEM_READY // 2026_PROTOCOL</p>
    
    <div class="grid">
        <div id="admin-card" class="card admin-only" onclick="openM('admin-modal')">
            <h3>ğŸ›¡ï¸ ç®¡ç†ç»ˆç«¯</h3>
            <p>æ—¥å¿—å®¡è®¡ä¸ç³»ç»Ÿç›‘æ§</p>
        </div>
        <div class="card" onclick="openM('lb-modal')">
            <h3>ğŸ† è£èª‰æ¦œå•</h3>
            <p>å…¨æœ XP æ’è¡Œ (æœˆæ¦œ/æ€»æ¦œ)</p>
        </div>
        <div class="card" onclick="openChat()">
            <h3>ğŸ’¬ ç»„é˜Ÿå¤§å…</h3>
            <p>å…¨æœå®æ—¶æˆ˜æœ¯é¢‘é“</p>
        </div>
        <div class="card" onclick="openM('f-modal')">
            <h3>ğŸ¤ æˆ‘çš„å¥½å‹</h3>
            <p>èº«ä»½éªŒè¯ä¸åŠ å¯†ç§èŠ</p>
        </div>
        <div class="card" onclick="openM('check-modal')">
            <h3>ğŸ“… æ¯æ—¥æ‰“å¡</h3>
            <p>é¢†å–ç‰©èµ„å¹¶èµšå– 100 XP</p>
        </div>
        <div class="card" onclick="openM('market-modal')">
            <h3>âš–ï¸ äº¤æ˜“è¡Œ</h3>
            <p>è‡ªç”±è´¸æ˜“ç‰©èµ„ä¸­å¿ƒ</p>
        </div>
        <div class="card" onclick="openM('wiki-modal')">
            <h3>ğŸ“– ç©æ³•ä»‹ç»</h3>
            <p>å†›å›¢æŒ‡ä»¤ä¸ç‰¹æŠ€æŒ‡å—</p>
        </div>
        <div class="card" onclick="openM('gift-modal')">
            <h3>ğŸ å…‘æ¢ç </h3>
            <p>é¢†å– 10 é’»çŸ³ä¸ç»éªŒå¥–åŠ±</p>
        </div>
    </div>
</div>

<div id="auth-modal" class="modal"><div class="modal-content">
    <h2 id="auth-title">èº«ä»½åŒæ­¥</h2>
    <input type="text" id="a-id" placeholder="å”¯ä¸€ç”Ÿå­˜ ID">
    <input type="text" id="a-nick" placeholder="æ˜µç§° (ä»…æ³¨å†Œæ—¶å¡«å†™)">
    <input type="password" id="a-pw" placeholder="å¯†ç ">
    <button class="btn" onclick="handleAuth()">æ‰§è¡ŒåŒæ­¥</button>
    <button class="btn" style="border-color:#444;color:#666" onclick="closeAll()">å–æ¶ˆ</button>
</div></div>

<div id="lb-modal" class="modal"><div class="modal-content">
    <h2 style="color:var(--neon)">è£èª‰æ’è¡Œæ¦œ</h2>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn" onclick="loadLeaderboard('total')">æ€»æ¦œ</button>
        <button class="btn" onclick="loadLeaderboard('month')">æœˆæ¦œ</button>
    </div>
    <div id="lb-list" style="max-height: 400px; overflow-y: auto;">åŠ è½½ä¸­...</div>
    <button class="btn" style="border-color:#444;color:#666" onclick="closeAll()">å…³é—­</button>
</div></div>

<div id="f-modal" class="modal"><div class="modal-content">
    <h2 style="color:var(--neon)">å¥½å‹ç»ˆç«¯</h2>
    <input type="text" id="f-id-input" placeholder="è¾“å…¥å¯¹æ–¹ç”Ÿå­˜ ID">
    <button class="btn" onclick="sendFRequest()">å‘é€å¥½å‹ç”³è¯·</button>
    <div id="f-requests" style="margin-top:15px; border-bottom:1px solid #333; padding-bottom:10px;"></div>
    <div id="f-list" style="margin-top:15px;"></div>
    <button class="btn" onclick="closeAll()">å…³é—­</button>
</div></div>

<div id="check-modal" class="modal"><div class="modal-content">
    <h2 style="color:var(--neon)">è¡¥ç»™ç­¾åˆ°</h2>
    <div class="check-grid" id="check-ui"></div>
    <button class="btn" id="check-btn" onclick="doCheckIn()">æ‰§è¡Œç­¾åˆ°</button>
    <button class="btn" style="border-color:#444;color:#666" onclick="closeAll()">è¿”å›</button>
</div></div>

<div id="market-modal" class="modal"><div class="modal-content">
    <h2 style="color:var(--neon)">äº¤æ˜“ä¸­å¿ƒ</h2>
    <input type="text" id="m-name" placeholder="ç‰©èµ„åç§°">
    <input type="number" id="m-price" placeholder="ä»·æ ¼ (å—)">
    <button class="btn" onclick="postItem()">ç«‹å³ä¸Šæ¶</button>
    <div id="market-list" style="margin-top:20px;"></div>
    <button class="btn" onclick="closeAll()">å…³é—­</button>
</div></div>

<div id="admin-modal" class="modal"><div class="modal-content" style="width: 500px;">
    <h2 style="color:var(--admin)">ç³»ç»Ÿå®¡è®¡ç»ˆç«¯</h2>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="btn" onclick="showLogs('DAILY_CHECK')">æ‰“å¡æ—¥å¿—</button>
        <button class="btn" onclick="showLogs('REDEEM')">å…‘æ¢æ—¥å¿—</button>
    </div>
    <div id="admin-log-list" style="height:350px; overflow-y:auto; background:#000; padding:10px; border:1px solid #333;"></div>
    <button class="btn" onclick="closeAll()">é€€å‡ºç»ˆç«¯</button>
</div></div>

<div id="wiki-modal" class="modal"><div class="modal-content">
    <h2 style="color:var(--neon)">ç”Ÿå­˜åè®®</h2>
    <p>!åˆ›å»ºå†›å›¢ | !é‚€è¯· | !å›åŸºåœ° | !è®¾ç½®åŸºåœ°</p>
    <p style="color: #ff5555; font-size: 12px;">* æˆ˜æ–—å—ä¼¤10ç§’å†…ç¦æ­¢ä¼ é€</p>
    <p><b>é»„é‡‘é¹¿è§’:</b> 5ç§’è·³è·ƒæå‡å’Œé€Ÿåº¦åŠ é€Ÿ</p>
    <button class="btn" onclick="closeAll()">è¿”å›</button>
</div></div>

<div id="gift-modal" class="modal"><div class="modal-content">
    <h2 style="color:var(--neon)">ç¤¼åŒ…å…‘æ¢</h2>
    <input type="text" id="g-game-name" placeholder="æ¸¸æˆå†…çš„åå­— (å¿…å¡«)">
    <input type="text" id="g-code" placeholder="è¾“å…¥å…‘æ¢ç ">
    <button class="btn" onclick="redeemCode()">ç«‹å³å…‘æ¢</button>
    <button class="btn" style="border-color:#444;color:#666" onclick="closeAll()">å–æ¶ˆ</button>
</div></div>

<div id="chat-window">
    <div style="padding:15px; border-bottom:1px solid var(--neon); display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center;">
            <img src="ç”Ÿå­˜æ³•åˆ™å›¾æ ‡.jpg" style="height:20px; margin-right:8px; border-radius:2px;">
            <span>å…¨æœæˆ˜æœ¯é¢‘é“</span>
        </div>
        <button onclick="openChat()" style="background:none;border:none;color:#fff;cursor:pointer;">âœ•</button>
    </div>
    <div id="chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:5px;"><input type="text" id="m-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="margin:0;"><button onclick="sendMsg()" class="btn" style="margin:0;width:auto;padding:0 15px;">å‘é€</button></div>
</div>

<div id="p-chat-window">
    <div style="padding:15px; border-bottom:1px solid var(--neon); display:flex; justify-content:space-between; align-items:center;">
        <div style="display:flex; align-items:center;">
            <img src="ç”Ÿå­˜æ³•åˆ™å›¾æ ‡.jpg" style="height:20px; margin-right:8px; border-radius:2px;">
            <span id="p-chat-title">ç§å¯†é“¾è·¯</span>
        </div>
        <button onclick="document.getElementById('p-chat-window').style.display='none'" style="background:none;border:none;color:#fff;cursor:pointer;">âœ•</button>
    </div>
    <div id="p-chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:5px;"><input type="text" id="p-m-input" placeholder="åŠ å¯†ä¼ è¾“..." style="margin:0;"><button onclick="sendPMsg()" class="btn" style="margin:0;width:auto;padding:0 15px;">å‘é€</button></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, doc, updateDoc, arrayUnion, where, getDoc, setDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { 
        apiKey: "AIzaSyBC92jwiCLsfG6bE4k2Jo4KQSiI-A_gxII", 
        authDomain: "bloxd-survival.firebaseapp.com", 
        projectId: "bloxd-survival", 
        storageBucket: "bloxd-survival.firebasestorage.app", 
        messagingSenderId: "60666065786", 
        appId: "1:60666065786:web:bdc3131accaceb0180dcc3" 
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let user = JSON.parse(localStorage.getItem('SURVIVAL_USER'));

    // ç®¡ç†å‘˜ç™½åå•
    const ADMIN_IDS = ["IKUN5556", "Peter_YT_Bilibili"];
    const rewards = ["10æœ¨å¤´", "10çŸ³å¤´", "10ç…¤ç‚­", "10é“", "10é»„é‡‘", "10é»„é‡‘", "10é’»çŸ³"];

    // å¼¹çª—æ§åˆ¶å™¨
    window.openM = (id) => { 
        closeAll(); 
        document.getElementById(id).style.display = 'block'; 
        if(id === 'lb-modal') loadLeaderboard('total');
        if(id === 'check-modal') renderCheckUI();
        if(id === 'admin-modal') showLogs('DAILY_CHECK');
    };
    window.closeAll = () => { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); };
    window.openChat = () => { 
        const c = document.getElementById('chat-window'); 
        c.style.display = (c.style.display==='flex'?'none':'flex'); 
    };

    // --- ğŸ¤ å¥½å‹ç³»ç»Ÿï¼šID å­˜åœ¨æ€§è¯†åˆ« ---
    window.sendFRequest = async () => {
        if(!user) return openM('auth-modal');
        const targetId = document.getElementById('f-id-input').value.trim();
        if(!targetId || targetId === user.id) return alert("æ— æ•ˆçš„ ID");

        // éªŒè¯ç›®æ ‡æ˜¯å¦å­˜åœ¨
        const tSnap = await getDoc(doc(db, "users", targetId));
        if (!tSnap.exists()) {
            return alert("âŒ è¯†åˆ«å¤±è´¥ï¼šè¯¥ç”Ÿå­˜ ID ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥å¤§å°å†™ã€‚");
        }

        await setDoc(doc(db, "friend_requests", `${targetId}_${user.id}`), {
            to: targetId,
            fromId: user.id,
            fromNick: user.nick,
            status: "pending",
            time: serverTimestamp()
        });
        alert("âœ… ç”³è¯·å·²å‘é€è‡³: " + tSnap.data().nick);
        document.getElementById('f-id-input').value = '';
    };

    // --- ğŸ“… æ‰“å¡ä¸ XP ç³»ç»Ÿ ---
    window.renderCheckUI = () => {
        const ui = document.getElementById('check-ui'); ui.innerHTML = '';
        const history = JSON.parse(localStorage.getItem(`CHECK_${user?.id}`)) || {count: 0};
        const today = new Date().toDateString();
        
        for(let i=0; i<7; i++) {
            const box = document.createElement('div');
            box.className = `day-box ${i < history.count ? 'claimed' : (i === history.count ? 'active' : '')}`;
            box.innerHTML = `ç¬¬${i+1}å¤©<br>${rewards[i]}`;
            ui.appendChild(box);
        }
        
        const btn = document.getElementById('check-btn');
        if(history.last === today) {
            btn.innerText = "ä»Šæ—¥å·²ç­¾åˆ°"; btn.disabled = true; btn.style.opacity = 0.5;
        } else {
            btn.innerText = "æ‰§è¡Œç­¾åˆ° (+100 XP)"; btn.disabled = false; btn.style.opacity = 1;
        }
    };

    window.doCheckIn = async () => {
        if(!user) return openM('auth-modal');
        const key = `CHECK_${user.id}`;
        let history = JSON.parse(localStorage.getItem(key)) || { count: 0, last: 0 };
        const now = new Date();
        const today = now.toDateString();
        const currentMonth = `${now.getFullYear()}-${now.getMonth() + 1}`;
        
        if(history.count >= 7) history.count = 0;
        const reward = rewards[history.count];
        history.count++; history.last = today;
        localStorage.setItem(key, JSON.stringify(history));

        // åŒæ­¥ XP
        const uRef = doc(db, "users", user.id);
        const monthField = `xp_month_${currentMonth}`;
        await updateDoc(uRef, {
            total_xp: increment(100),
            [monthField]: increment(100)
        });

        await addDoc(collection(db, "logs"), { 
            type: "DAILY_CHECK", userId: user.id, nick: user.nick, reward, time: serverTimestamp() 
        });
        alert(`ğŸ‰ æˆåŠŸï¼è·å¾— ${reward} å’Œ 100 XP`);
        renderCheckUI();
    };

    // --- ğŸ† æ’è¡Œæ¦œç³»ç»Ÿ ---
    window.loadLeaderboard = (type) => {
        const listDiv = document.getElementById('lb-list');
        listDiv.innerHTML = "æ­£åœ¨åŒæ­¥äº‘ç«¯æ’å...";
        const curM = `${new Date().getFullYear()}-${new Date().getMonth() + 1}`;
        const sortF = type === 'total' ? 'total_xp' : `xp_month_${curM}`;
        
        onSnapshot(query(collection(db, "users"), orderBy(sortF, "desc"), limit(10)), (sn) => {
            listDiv.innerHTML = ''; let rank = 1;
            sn.forEach(d => {
                const p = d.data(); const xp = p[sortF] || 0;
                if(type === 'month' && xp === 0) return;
                const row = document.createElement('div');
                row.className = `lb-row ${rank <= 3 ? 'top3' : ''}`;
                row.innerHTML = `<span>#${rank} <b>${p.nick}</b></span><span>${xp} XP</span>`;
                listDiv.appendChild(row); rank++;
            });
            if(!listDiv.innerHTML) listDiv.innerHTML = "æ¦œå•ç©ºç©ºå¦‚ä¹Ÿ...";
        });
    };

    // --- ğŸ’¬ å¤§å…èŠå¤© ---
    window.sendMsg = async () => {
        const i = document.getElementById('m-input'); 
        if(i.value && user) { 
            await addDoc(collection(db, "messages"), { text: i.value, user: user.nick, createdAt: serverTimestamp() }); 
            i.value=''; 
        } else if(!user) openM('auth-modal');
    };
    onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(50)), (sn) => {
        const b = document.getElementById('chat-msgs'); b.innerHTML = '';
        sn.forEach(d => { 
            const m = d.data(); const div = document.createElement('div'); 
            div.className='msg'; div.innerHTML=`<b>${m.user}</b> ${m.text}`; b.appendChild(div); 
        });
        b.scrollTop = b.scrollHeight;
    });

    // --- ğŸ”’ èº«ä»½éªŒè¯ä¸ç®¡ç†è¯†åˆ« ---
    window.handleAuth = async () => {
        const id = document.getElementById('a-id').value.trim();
        const nick = document.getElementById('a-nick').value.trim();
        const pw = document.getElementById('a-pw').value.trim();
        if(!id || !pw) return alert("å¿…å¡«å­—æ®µç¼ºå¤±");
        
        const key = 'DB_USER_' + id;
        const saved = localStorage.getItem(key);

        if(!saved) {
            if(!nick) return alert("æ–°ç”¨æˆ·éœ€å¡«å†™æ˜µç§°");
            await setDoc(doc(db, "users", id), { id, nick, total_xp: 0, friends: [] });
            user = { id, nick, pw };
            localStorage.setItem(key, JSON.stringify(user));
            await addDoc(collection(db, "logs"), { type: "REGISTER", userId: id, nick, time: serverTimestamp() });
        } else {
            const d = JSON.parse(saved);
            if(d.pw !== pw) return alert("éªŒè¯å¤±è´¥");
            user = d;
        }
        localStorage.setItem('SURVIVAL_USER', JSON.stringify(user));
        location.reload();
    };

    window.logout = () => { localStorage.removeItem('SURVIVAL_USER'); location.reload(); };

    // --- âš–ï¸ äº¤æ˜“è¡Œ & ç§èŠé€»è¾‘ç­‰ (è¡¥å®Œ) ---
    window.postItem = async () => {
        if(!user) return openM('auth-modal');
        const n = document.getElementById('m-name').value;
        const p = document.getElementById('m-price').value;
        if(n && p) await addDoc(collection(db, "market"), { name: n, price: p, seller: user.nick, sellerId: user.id, comments: [], time: serverTimestamp() });
    };

    onSnapshot(collection(db, "market"), (sn) => {
        const l = document.getElementById('market-list'); l.innerHTML = '';
        sn.forEach(d => {
            const it = d.data(); const div = document.createElement('div');
            div.style = "background:#000; padding:15px; border:1px solid #333; margin-bottom:10px; text-align:left;";
            let cs = (it.comments || []).map(c => `<div class="comment-box"><b>${c.user}:</b> ${c.text}</div>`).join('');
            div.innerHTML = `<b>ğŸ“¦ ${it.name}</b> <span style="color:var(--neon)">${it.price} å—</span><br><small>å–å®¶: ${it.seller}</small><div>${cs}</div><button class="btn" style="width:auto;font-size:10px;padding:2px 8px" onclick="addCom('${d.id}')">æ²Ÿé€š</button>${it.sellerId===user?.id?`<button class="btn" style="width:auto;font-size:10px;padding:2px 8px;border-color:red;color:red" onclick="delIt('${d.id}')">ä¸‹æ¶</button>`:''}`;
            l.appendChild(div);
        });
    });

    window.addCom = async (id) => { if(!user) return openM('auth-modal'); const t = prompt("ç•™è¨€:"); if(t) await updateDoc(doc(db, "market", id), { comments: arrayUnion({ user: user.nick, text: t }) }); };
    window.delIt = async (id) => { await deleteDoc(doc(db, "market", id)); };

    window.showLogs = (type) => {
        onSnapshot(query(collection(db, "logs"), where("type", "==", type), orderBy("time", "desc"), limit(20)), (sn) => {
            const box = document.getElementById('admin-log-list'); box.innerHTML = '';
            sn.forEach(d => {
                const log = d.data(); const div = document.createElement('div');
                div.className = 'f-item'; div.innerHTML = `<span><b>${log.nick}</b><br><small>${log.time?.toDate().toLocaleString()}</small></span><span>${log.reward || 'ç™»å½•'}</span>`;
                box.appendChild(div);
            });
        });
    };

    if(user) {
        document.getElementById('auth-ui').innerHTML = `<span>â— ${user.nick}</span> <button onclick="logout()" class="btn" style="width:auto;margin:0;padding:5px 10px;">é€€å‡º</button>`;
        if(ADMIN_IDS.includes(user.id)) document.getElementById('admin-card').style.display = 'block';
    } else {
        document.getElementById('auth-ui').innerHTML = `<button onclick="openM('auth-modal')" class="btn" style="width:auto;margin:0;padding:5px 15px;">åŒæ­¥èº«ä»½</button>`;
    }
</script>
</body>
</html>
