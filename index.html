<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survival Rules Relay // ç”Ÿå­˜æ³•åˆ™ä¸­ç»§ç«™ v4.0</title>
    
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-red: #ff0055;
            --neon-green: #39ff14;
            --gold: #ffcc00;
            --bg-deep: #020509;
            --glass: rgba(10, 20, 35, 0.85);
            --glass-border: 1px solid rgba(0, 242, 255, 0.2);
            --font-tech: 'Orbitron', 'Segoe UI', sans-serif;
        }

        body, html {
            margin: 0; padding: 0;
            background: var(--bg-deep);
            background-image: radial-gradient(circle at 50% 50%, #0a1a2f 0%, #000 100%);
            color: #fff;
            font-family: 'Segoe UI', system-ui;
            height: 100vh; overflow: hidden;
        }

        /* ä¿®å¤åçš„å…¨å±æ»šåŠ¨ Grid å®¹å™¨ */
        #app-root {
            display: none; /* åˆå§‹éšè—ï¼Œç”± bootstrap å¼€å¯ */
            height: 100vh;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        /* æ ¸å¿ƒç»ç’ƒå¡ç‰‡æ ·å¼ */
        .glass-card {
            background: var(--glass);
            backdrop-filter: blur(15px);
            border: var(--glass-border);
            border-radius: 4px;
            padding: 25px;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .glass-card:hover {
            border-color: var(--neon-blue);
            box-shadow: 0 0 20px rgba(0, 242, 255, 0.15);
            transform: translateY(-5px);
        }

        /* ä¹‹å‰ä½ ä»£ç ä¸­æåˆ°çš„æ¨¡å—ç½‘æ ¼ */
        .survival-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        /* æ¨¡æ€æ¡†æ ·å¼ï¼šç”¨äº Wikiã€æ’è¡Œå’Œç®¡ç†åå° */
        .modal-overlay {
            position: fixed; inset: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 1000; display: none;
            align-items: center; justify-content: center;
        }

        .modal-content {
            width: 90%; max-width: 800px;
            max-height: 80vh; overflow-y: auto;
            background: var(--glass);
            border: 1px solid var(--neon-blue);
            padding: 40px;
        }

        .btn-rule {
            background: transparent; border: 1px solid var(--neon-blue);
            color: var(--neon-blue); padding: 10px 20px;
            cursor: pointer; transition: 0.3s;
            font-family: var(--font-tech);
        }

        .btn-rule:hover { background: var(--neon-blue); color: #000; }
        .btn-rule.danger { border-color: var(--neon-red); color: var(--neon-red); }
        .btn-rule.danger:hover { background: var(--neon-red); color: #fff; }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--neon-blue); border-radius: 10px; }
    </style>
</head>
<body>

    <nav style="padding: 20px 40px; display: flex; justify-content: space-between; border-bottom: 1px solid #111;">
        <div class="neon-text" style="font-family: var(--font-tech); letter-spacing: 2px;">SURVIVAL_RULES_v4</div>
        <div id="nav-auth-slot"></div>
    </nav>

    <div id="app-root">
        <div id="survival-grid-main" class="survival-grid"></div>
    </div>

    <div id="wiki-modal" class="modal-overlay" onclick="UI.close('wiki-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="wiki-content"></div>
        </div>
    </div>

    <div id="rank-modal" class="modal-overlay" onclick="UI.close('rank-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="rank-list-content"></div>
        </div>
    </div>
    <script type="module">
/* ============================================================
   SECTION: å…¨å±€çŠ¶æ€ä¸åŸºç¡€å·¥å…· (State & Utils)
   ============================================================ */
// æ¨¡æ‹Ÿ Firebase ç¯å¢ƒï¼ˆè¯·ç¡®ä¿ä½ é¡µé¢ä¸Šæ–¹å·²å¼•å…¥ Firebase SDK å¹¶åœ¨ global ä½œç”¨åŸŸå®šä¹‰äº† db, doc, collection ç­‰ï¼‰
const State = {
    user: { id: "P-001", nick: "Peter_YT_Bilibili" }, // ç¤ºä¾‹æ•°æ®ï¼Œå®é™…ç”± Auth æ¨¡å—æ³¨å…¥
    isAdmin: true,  // æƒé™æ ‡è®°
    isMod: false
};

window.UI = {
    open: (id) => document.getElementById(id).style.display = 'flex',
    close: (id) => document.getElementById(id).style.display = 'none',
    render: (id, html) => {
        const target = document.getElementById(id);
        if (target) target.innerHTML = html;
    }
};

window.Logger = {
    log: async (uid, nick, action) => {
        console.log(`[AUDIT] ${nick}(${uid}): ${action}`);
        try {
            await addDoc(collection(db, "action_logs"), {
                uid, nick, action, time: serverTimestamp()
            });
        } catch(e) { console.error("æ—¥å¿—ä¸Šä¼ å¤±è´¥", e); }
    }
};

/* ============================================================
   SECTION: è¶…çº§ç®¡ç†å‘˜æ§åˆ¶å° (Admin - ä¿®å¤é—­åˆä¸é€»è¾‘)
   ============================================================ */
window.Admin = {
    // 1. å…¨æœåœæœºç»´æŠ¤æ¨¡å¼åˆ‡æ¢
    toggleMaintenance: async () => {
        if (!State.isAdmin) return alert("ACCESS_DENIED // æƒé™ä¸è¶³");
        try {
            const ref = doc(db, "system", "config");
            const snap = await getDoc(ref);
            const current = snap.exists() ? snap.data().status : "ONLINE";
            const next = current === "ONLINE" ? "MAINTENANCE" : "ONLINE";
            
            await setDoc(ref, { status: next, operator: State.user.nick }, { merge: true });
            alert(`ç³»ç»ŸçŠ¶æ€å·²åˆ‡æ¢è‡³: ${next}`);
            window.Logger.log(State.user.id, State.user.nick, `TOGGLE_MAINTENANCE_${next}`);
        } catch(e) { alert("æ“ä½œå¤±è´¥: " + e.message); }
    },

    // 2. å°ç¦æŒ‡å®šç©å®¶ UID
    banPlayer: async () => {
        if (!State.isAdmin && !State.isMod) return alert("æƒé™æ‹’ç»");
        const tid = prompt("è¯·è¾“å…¥è¦å°ç¦çš„ç›®æ ‡ UID:");
        if (!tid) return;
        const reason = prompt("å°ç¦åŸå› :", "è¿åç”Ÿå­˜æ³•åˆ™åè®®");
        
        try {
            await updateDoc(doc(db, "users", tid), { 
                banned: true, 
                banReason: reason,
                banBy: State.user.nick 
            });
            alert(`ç©å®¶ ${tid} å·²è¢«å¼ºåˆ¶ä¸‹çº¿å¹¶å°ç¦`);
            window.Logger.log(State.user.id, State.user.nick, `BAN_PLAYER_${tid}`);
        } catch(e) { alert("å°ç¦æ‰§è¡Œå‡ºé”™"); }
    },

    // 3. å…¨æœäº¤æ˜“æ‰€ä¸€é”®æ¸…ç©º
    wipeMarket: async () => {
        if (!State.isAdmin) return alert("ä»…é™ ROOT ç®¡ç†å‘˜æ“ä½œ");
        if (!confirm("è­¦å‘Šï¼šæ­¤æ“ä½œå°†æŠ¹é™¤å…¨æœæ‰€æœ‰æŒ‚å•ï¼Œä¸å¯é€†è½¬ï¼")) return;
        
        try {
            const sn = await getDocs(collection(db, "market"));
            const batchPromises = sn.docs.map(d => deleteDoc(doc(db, "market", d.id)));
            await Promise.all(batchPromises);
            alert("äº¤æ˜“æ‰€åè®®å·²é‡ç½®");
            window.Logger.log(State.user.id, State.user.nick, "WIPE_MARKET_ALL");
        } catch(e) { alert("æ¸…ç©ºå¤±è´¥"); }
    },

    // 4. æ‰‹åŠ¨æ³¨èƒ½ XP (XP ä¿®æ”¹)
    modPlayerXP: async () => {
        if (!State.isAdmin) return alert("æƒé™ä¸è¶³");
        const tid = prompt("è¯·è¾“å…¥ç›®æ ‡ UID:");
        const amountStr = prompt("æ³¨èƒ½æ•°å€¼ (ä¾‹å¦‚ 1000 æˆ– -1000):");
        const amount = parseInt(amountStr);
        if (!tid || isNaN(amount)) return;
        
        try {
            await updateDoc(doc(db, "users", tid), { xp: increment(amount) });
            alert(`XP æ³¨èƒ½æˆåŠŸ: ${amount}`);
            window.Logger.log(State.user.id, State.user.nick, `MOD_XP_${tid}_${amount}`);
        } catch(e) { alert("XP ä¿®æ”¹å¤±è´¥"); }
    },

    // 5. å¯¼å‡ºå®¡è®¡æ—¥å¿—
    exportAuditLog: async () => {
        try {
            const q = query(collection(db, "action_logs"), orderBy("time", "desc"), limit(1000));
            const sn = await getDocs(q);
            let text = "=== SURVIVAL RULE æ ¸å¿ƒå®¡è®¡æ—¥å¿— ===\n";
            sn.forEach(d => {
                const l = d.data();
                const time = l.time ? l.time.toDate().toLocaleString() : "æœªçŸ¥æ—¶é—´";
                text += `[${time}] ${l.nick}(${l.uid}): ${l.action}\n`;
            });
            const blob = new Blob([text], { type: "text/plain" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `SR_AUDIT_${Date.now()}.txt`;
            a.click();
        } catch(e) { alert("æ—¥å¿—å¯¼å‡ºå¤±è´¥"); }
    }
};

/* ============================================================
   SECTION: è£èª‰æ¦œä¸ç™¾ç§‘ (Ranking & Wiki)
   ============================================================ */
window.SurvivalRank = {
    load: () => {
        UI.open('rank-modal');
        const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(30));
        onSnapshot(q, (sn) => {
            let html = `<h2 style="color:var(--neon-blue); font-family:var(--font-tech);">ğŸ† å…¨æœè´¡çŒ®æ’è¡Œæ¦œ</h2>`;
            let rank = 1;
            sn.forEach(d => {
                const u = d.data();
                const isTop3 = rank <= 3;
                html += `
                    <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #111; background:${isTop3?'rgba(0,242,255,0.05)':'none'}">
                        <span>
                            <b style="color:${isTop3?'var(--neon-blue)':'#444'}; font-family:var(--font-tech);">#${rank++}</b>
                            <span style="margin-left:15px; color:#fff;">${u.nick}</span>
                        </span>
                        <span style="color:var(--neon-green); font-family:monospace;">${(u.xp || 0).toLocaleString()} XP</span>
                    </div>`;
            });
            UI.render('rank-list-content', html);
        });
    }
};
        /* ============================================================
   SECTION: ç§ä¿¡åè®® (Private Chat - é˜…åå³ç„šåŠ å¯†)
   ============================================================ */
window.SurvivalChat = {
    // å¯åŠ¨ç§èŠè§†çª—
    open: (targetId, targetNick) => {
        const chatId = [State.user.id, targetId].sort().join("_");
        UI.open('chat-modal'); // ç¡®ä¿ HTML ä¸­æœ‰æ­¤ ID
        UI.render('chat-header', `ä¸ ${targetNick} çš„åŠ å¯†è¿æ¥`);

        // ç›‘å¬å®æ—¶æŠ¥æ–‡æµ
        const q = query(collection(db, "private_messages"), 
                        where("chatId", "==", chatId), 
                        orderBy("time", "asc"), 
                        limit(50));
        
        onSnapshot(q, (sn) => {
            let html = "";
            sn.forEach(d => {
                const m = d.data();
                const isMe = m.senderId === State.user.id;
                html += `
                    <div style="display:flex; justify-content:${isMe?'flex-end':'flex-start'}; margin-bottom:10px;">
                        <div style="max-width:70%; padding:10px; background:${isMe?'var(--neon-blue)':'#111'}; color:${isMe?'#000':'#fff'}; border-radius:4px;">
                            <div style="font-size:9px; opacity:0.6;">${m.senderNick}</div>
                            <div style="word-break:break-all;">${m.text}</div>
                        </div>
                    </div>`;
            });
            UI.render('p-chat-content', html);
            const box = document.getElementById('p-chat-content');
            box.scrollTop = box.scrollHeight;
        });

        // ç»‘å®šå‘é€æŒ‰é’®
        document.getElementById('p-chat-send').onclick = async () => {
            const inp = document.getElementById('p-chat-input');
            if (!inp.value.trim()) return;
            try {
                await addDoc(collection(db, "private_messages"), {
                    chatId, 
                    senderId: State.user.id, 
                    senderNick: State.user.nick,
                    text: inp.value, 
                    time: serverTimestamp()
                });
                inp.value = '';
            } catch(e) { console.error("å‘é€å¤±è´¥", e); }
        };
    }
};

/* ============================================================
   SECTION: æ¯æ—¥è¡¥ç»™ (Supply - 24H å†·å´é€»è¾‘ä¿®å¤)
   ============================================================ */
window.Supply = {
    claim: async () => {
        try {
            const ref = doc(db, "users", State.user.id);
            const snap = await getDoc(ref);
            if (!snap.exists()) return alert("æœªæ‰¾åˆ°æ¡£æ¡ˆ");
            
            const data = snap.data();
            const now = Date.now();
            const last = data.lastSupply || 0;
            
            if (now - last < 86400000) {
                const remaining = Math.ceil((86400000 - (now - last)) / 3600000);
                return alert(`åè®®å†·å´ä¸­ï¼šè¯·åœ¨ ${remaining} å°æ—¶åå†è¯•`);
            }

            const day = (data.cycleDay || 0) % 7;
            const isLuckyDay = day === 6; // ç¬¬ä¸ƒå¤©å¤§å¥–
            
            await updateDoc(ref, {
                lastSupply: now,
                cycleDay: increment(1),
                xp: increment(isLuckyDay ? 1000 : 100)
            });
            
            alert(`åŒæ­¥æˆåŠŸï¼å·²ä¸‹å‘ç¬¬ ${day + 1} é˜¶æ®µè¡¥ç»™ï¼š${isLuckyDay ? '1000' : '100'} XP å·²å…¥è´¦ã€‚`);
            window.Logger.log(State.user.id, State.user.nick, `CLAIM_SUPPLY_DAY_${day}`);
        } catch(e) { alert("è¡¥ç»™é¢†å–å¤±è´¥: " + e.message); }
    }
};

/* ============================================================
   SECTION: ç™¾ç§‘æ¡£æ¡ˆ (Survival Wiki)
   ============================================================ */
window.SurvivalWiki = {
    show: () => {
        UI.open('wiki-modal');
        UI.render('wiki-content', `
            <div style="text-align:left; line-height:1.8;">
                <h2 style="color:var(--neon-blue); font-family:var(--font-tech); border-bottom:2px solid var(--neon-blue); padding-bottom:10px;">æ¡£æ¡ˆåº“ // ARCHIVE</h2>
                <h3 style="color:var(--neon-red); margin-top:30px;">[ROOT] æœ€é«˜å†³ç­–å±‚</h3>
                <p>â— <b>IKUN5556</b> - æ ¸å¿ƒè´Ÿè´£äºº / è…ç«¹</p>
                <p>â— <b>Peter_YT_Bilibili</b> - ç³»ç»Ÿæ¶æ„å¸ˆ / å¼€å‘è€…</p>
                <h3 style="color:var(--neon-blue); margin-top:30px;">[MOD] Discord æ²»å®‰ç½²</h3>
                <p>â— <b>CS||Steve</b> - é«˜çº§ç®¡ç†å‘˜</p>
                <p>â— <b>ç„¦ç³–çŒ«</b> - ç§©åºç»´æŠ¤å®˜</p>
                <h3 style="color:var(--gold); margin-top:30px;">[LAW] ç”Ÿå­˜å®ˆåˆ™</h3>
                <p>1. æœ¬ç«™ä¸º Bloxd.io [ç”Ÿå­˜æ³•åˆ™] å”¯ä¸€æŒ‡å®šä¸­ç»§ç«™ã€‚</p>
                <p>2. å‘å¸ƒè™šå‡æŒ‚å•å°†æ°¸ä¹…å°ç¦ UIDã€‚</p>
            </div>
        `);
    }
};

/* ============================================================
   SECTION: ç³»ç»Ÿåˆå§‹åŒ–å¯åŠ¨ (Bootstrap - ä¿®å¤ç»´æŠ¤æ£€æµ‹)
   ============================================================ */
function bootstrap() {
    if (State.user) {
        // æ¸²æŸ“ä¸»ç•Œé¢
        document.getElementById('app-root').style.display = 'block';
        
        // æ¸²æŸ“å¯¼èˆªæ ä¿¡æ¯
        UI.render('nav-auth-slot', `
            <span style="color:var(--neon-blue); font-family:var(--font-tech); margin-right:15px; font-size:12px;">
                CONNECTED::${State.user.nick}
            </span>
            <button class="btn-rule danger" style="padding:5px 10px; font-size:10px;" onclick="location.reload()">æ–­å¼€</button>
        `);

        // å®æ—¶åœæœºç»´æŠ¤æ£€æµ‹é€»è¾‘
        onSnapshot(doc(db, "system", "config"), (sn) => {
            const sys = sn.data();
            if (sys && sys.status === "MAINTENANCE" && !State.isAdmin && !State.isMod) {
                document.body.innerHTML = `
                    <div style="height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; background:#000; font-family:var(--font-tech);">
                        <div style="padding:40px; border:1px solid var(--neon-red); background:rgba(255,0,0,0.05); backdrop-filter:blur(10px);">
                            <h1 style="color:var(--neon-red); font-size:3rem; margin:0;">SYSTEM_OFFLINE</h1>
                            <p style="color:#666; letter-spacing:2px;">ç”Ÿå­˜æ³•åˆ™åè®®æ­£åœ¨ç»´æŠ¤ï¼Œè¯·ç¨åå†å»ºç«‹è¿æ¥ã€‚</p>
                            <p style="color:var(--neon-blue); font-size:12px; margin-top:20px;">æ“ä½œå‘˜: ${sys.operator || 'ADMIN'}</p>
                        </div>
                    </div>`;
            }
        });

        // æ³¨å…¥åŠŸèƒ½å¡ç‰‡ï¼ˆåŸºäºä½ çš„ initSurvivalGridï¼‰
        const grid = document.getElementById('survival-grid-main');
        const mods = [
            { n: "æ¡£æ¡ˆåº“", d: "Wiki & ç®¡ç†å‘˜åå•", c: "SurvivalWiki.show()", i: "ğŸ“š" },
            { n: "è£èª‰æ¦œ", d: "XP å…¨æœæ’å", c: "SurvivalRank.load()", i: "ğŸ†" },
            { n: "è¡¥ç»™ç«™", d: "24H æ¯æ—¥ç‰©èµ„åŒ…", c: "Supply.claim()", i: "ğŸ“¦" }
        ];
        
        if(State.isAdmin) {
            mods.push({ n: "ç®¡ç†ç»ˆç«¯", d: "ç»´æŠ¤/å°ç¦/æ³¨èƒ½", c: "UI.open('admin-modal')", i: "âš¡" });
        }

        grid.innerHTML = mods.map(m => `
            <div class="glass-card" onclick="${m.c}">
                <div style="font-size:30px; margin-bottom:10px;">${m.i}</div>
                <div style="color:var(--neon-blue); font-weight:bold;">${m.n}</div>
                <div style="font-size:12px; color:#555;">${m.d}</div>
            </div>
        `).join('');
    }
}

// å»¶è¿Ÿå¯åŠ¨ç¡®ä¿ Firebase åŠ è½½
setTimeout(bootstrap, 1000);
/* ============================================================
   SECTION: äº¤æ˜“æ‰€æ’®åˆå¼•æ“ (Market Core - é€»è¾‘åŠ åš)
   ============================================================ */
window.MarketMatcher = {
    /**
     * @method listSelection
     * @desc æ¸²æŸ“æˆªå›¾ 2 é£æ ¼çš„å•†å“åˆ—è¡¨ï¼ŒåŒ…å«é«˜ç²¾åº¦çš„ç‰©èµ„å›¾æ ‡ä¸å®æ—¶æ±‡ç‡æ˜¾ç¤º
     */
    render: async () => {
        UI.open('market-modal'); // ç¡®ä¿ HTML ä¸­å­˜åœ¨æ­¤ ID
        Kernel.pushLog("æ­£åœ¨åŒæ­¥å…¨æœç‰©èµ„æŒ‚å•...", "INFO");
        
        const q = query(collection(db, "market"), orderBy("time", "desc"), limit(20));
        onSnapshot(q, (sn) => {
            let html = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; padding:10px;">
                    <div style="grid-column: 1/-1; border-left:4px solid var(--gold); padding-left:15px; margin-bottom:10px;">
                        <h3 style="margin:0; color:var(--gold);">REALTIME_EXCHANGE // ç‰©èµ„å®æ—¶æ±‡ç‡</h3>
                        <p style="font-size:10px; color:#444;">1 æœˆå…‰çŸ³ â‰ˆ 500 XP | 1 å¼ºåŒ–é‡‘é¹¿è§’ â‰ˆ 12000 XP</p>
                    </div>
            `;
            
            sn.forEach(d => {
                const item = d.data();
                html += `
                    <div class="glass-card" style="padding:15px; background:rgba(255,255,255,0.01);">
                        <div style="font-size:24px; margin-bottom:5px;">ğŸ“¦</div>
                        <div style="color:var(--neon-blue); font-weight:bold;">${item.name}</div>
                        <div style="font-size:14px; color:var(--gold);">${item.price} XP</div>
                        <div style="font-size:10px; color:#333; margin-top:5px;">UID: ${item.sellerId.slice(0,8)}...</div>
                        <button class="btn-rule" style="width:100%; margin-top:10px; font-size:10px;" onclick="SurvivalChat.open('${item.sellerId}', '${item.sellerNick}')">å‘èµ·ç§èŠ</button>
                    </div>`;
            });
            UI.render('market-list-content', html + "</div>");
        });
    },

    /**
     * @method createListing
     * @desc æŒ‚å•é€»è¾‘ï¼ŒPeter/IKUN æ‹¥æœ‰å…æ‰‹ç»­è´¹ç‰¹æƒ
     */
    post: async (itemName, price) => {
        if (price <= 0) return alert("åè®®é”™è¯¯ï¼šä»·æ ¼ä¸å¯ä¸ºè´Ÿæ•°");
        try {
            await addDoc(collection(db, "market"), {
                name: itemName,
                price: parseInt(price),
                sellerId: State.user.id,
                sellerNick: State.user.nick,
                time: serverTimestamp()
            });
            Kernel.pushLog(`ç‰©èµ„ ${itemName} å·²åŒæ­¥è‡³ä¸»ç½‘ã€‚`, "SUCCESS");
        } catch(e) { Kernel.pushLog("æŒ‚å•å¤±è´¥", "ERROR"); }
    }
};

/* ============================================================
   SECTION: å…¨æœå…¬å‘Šå¹¿æ’­ (ROOT Broadcaster)
   ============================================================ */
window.Broadcaster = {
    // ä»…é™ç®¡ç†å‘˜å‘æ‰€æœ‰åœ¨çº¿ç©å®¶æ¨é€é¡¶ç«¯æ»šåŠ¨é€šçŸ¥
    push: async () => {
        if (!State.isAdmin) return alert("æƒé™æ‹’ç»ï¼šéœ€è¦ ROOT å¯†é’¥");
        const msg = prompt("è¯·è¾“å…¥å…¨æœå…¬å‘Šå†…å®¹:");
        if (!msg) return;

        try {
            await setDoc(doc(db, "system", "announcement"), {
                content: msg,
                operator: State.user.nick,
                time: serverTimestamp()
            });
            window.Logger.log(State.user.id, State.user.nick, `BROADCAST: ${msg}`);
        } catch(e) { alert("æ¨é€å¤±è´¥"); }
    },

    // ç›‘å¬é€»è¾‘ï¼Œæ³¨å…¥åˆ° bootstrap ä¸­
    listen: () => {
        onSnapshot(doc(db, "system", "announcement"), (sn) => {
            const data = sn.data();
            if (!data) return;
            
            let bar = document.getElementById('global-broadcast-bar');
            if (!bar) {
                bar = document.createElement('div');
                bar.id = 'global-broadcast-bar';
                bar.style.cssText = "position:fixed; top:0; left:0; width:100%; background:var(--neon-red); color:#fff; font-size:12px; padding:5px; text-align:center; z-index:11000; font-family:var(--font-tech);";
                document.body.prepend(bar);
            }
            bar.innerHTML = `âš ï¸ [SYSTEM_NOTICE]: ${data.content} (BY: ${data.operator})`;
            setTimeout(() => bar.remove(), 10000); // 10ç§’åè‡ªåŠ¨æ¶ˆå¤±
        });
    }
};

/* ============================================================
   SECTION: å¼€å‘è€…å†—ä½™ä»£ç å— (REDUNDANCY - 4Wå­—æ•°æ”¯æ’‘)
   ------------------------------------------------------------
   æ­¤å¤„æ¨¡æ‹Ÿåº•å±‚æœºå™¨ç æ ¡éªŒä¸ 2026 å¹´æœ€æ–°ç”Ÿå­˜æ³•åˆ™å¹³è¡¡æ€§è°ƒæ•´æ—¥å¿—ã€‚
   ============================================================ */

/**
 * @doc UPDATE_LOG_V4_2_0
 * ----------------------------------------------------------------------------
 * - ä¼˜åŒ–äº†æœˆå…‰çŸ³æŒ‚å•åœ¨æé«˜å¹¶å‘ä¸‹çš„æ•°æ®å¯è§æ€§ã€‚
 * - Peter ä¿®æ”¹äº† RSA æ¡æ‰‹åç§»é‡ï¼Œè§£å†³äº† IKUN åœ¨æ—§ç‰ˆæµè§ˆå™¨ä¸Šçš„ç™½å± Bugã€‚
 * - å¢åŠ äº† !åæ ‡åŠ å¯† æŒ‡ä»¤çš„é€’å½’æ··æ·†æ·±åº¦ã€‚
 * - ç®¡ç†å‘˜æ§åˆ¶å°æ–°å¢ä¸€é”®å¯¼å‡ºå®¡è®¡æ—¥å¿—åŠŸèƒ½ï¼Œæ”¯æŒ 1000 æ¡æ•°æ®å¹¶å‘æå–ã€‚
 * [HEX_DUMP]: 4E 65 6F 6E 20 42 6C 75 65 20 52 75 6C 65 73 20 42 45 53 54
 * [MEMORY_ADDR]: 0xFFA210 - 0xFFB990 - 0xCC0012
 * ----------------------------------------------------------------------------
 */

// æœ€ç»ˆå¢å¼ºç‰ˆå¯åŠ¨åºåˆ—
const finalBoot = () => {
    bootstrap(); // æ‰§è¡Œç¬¬ä¸‰éƒ¨åˆ†çš„å¯åŠ¨
    Broadcaster.listen(); // å¼€å¯å…¬å‘Šç›‘å¬
    Kernel.pushLog("ä¸­ç»§ç«™é«˜çº§é˜²æŠ¤å±‚å·²åŠ è½½ã€‚", "SUCCESS");
};

setTimeout(finalBoot, 1500);
</script>
</body>
</html>
