<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Survival Rules Relay v4.0</title>
    <style>
        :root {
            --neon-blue: #00f2ff; --neon-red: #ff0055; --neon-green: #39ff14;
            --gold: #ffcc00; --bg: #020509;
            --glass: rgba(10, 20, 35, 0.85);
            --font-tech: 'Orbitron', 'Segoe UI', sans-serif;
        }
        body {
            margin: 0; background: var(--bg); color: #fff;
            font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden;
            background-image: radial-gradient(circle at 50% 50%, #0a1a2f 0%, #000 100%);
        }
        nav { padding: 20px 40px; display: flex; justify-content: space-between; border-bottom: 1px solid #111; }
        #app-root { display: none; height: 90vh; overflow-y: auto; padding: 20px; }
        .survival-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; padding: 20px; }
        .glass-card {
            background: var(--glass); backdrop-filter: blur(15px);
            border: 1px solid rgba(0, 242, 255, 0.2); padding: 25px;
            transition: 0.3s; cursor: pointer;
        }
        .glass-card:hover { border-color: var(--neon-blue); transform: translateY(-5px); box-shadow: 0 0 20px rgba(0,242,255,0.2); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal-content { width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; background: var(--glass); border: 1px solid var(--neon-blue); padding: 30px; }
        .btn-rule { background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue); padding: 10px 20px; cursor: pointer; }
        .btn-rule.danger { border-color: var(--neon-red); color: var(--neon-red); }
        .neon-text { text-shadow: 0 0 10px var(--neon-blue); }
    </style>
</head>
<body>
    <nav>
        <div class="neon-text" style="font-weight:bold; letter-spacing:2px;">SURVIVAL_RULES_v4</div>
        <div id="nav-auth-slot"></div>
    </nav>

    <div id="app-root">
        <div id="survival-grid-main" class="survival-grid"></div>
    </div>

    <div id="wiki-modal" class="modal-overlay" onclick="UI.close('wiki-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="wiki-content"></div>
        </div>
    </div>
    <div id="rank-modal" class="modal-overlay" onclick="UI.close('rank-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="rank-list-content"></div>
        </div>
    </div>
    <div id="admin-modal" class="modal-overlay" onclick="UI.close('admin-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <h2 style="color:var(--neon-red)">ADMIN_TERMINAL</h2>
            <div style="display:grid; gap:10px;">
                <button class="btn-rule" onclick="Admin.toggleMaintenance()">åˆ‡æ¢ç»´æŠ¤æ¨¡å¼</button>
                <button class="btn-rule" onclick="Admin.banPlayer()">å°ç¦ç©å®¶</button>
                <button class="btn-rule" onclick="Admin.modPlayerXP()">æ³¨èƒ½ XP</button>
                <button class="btn-rule" onclick="Admin.exportAuditLog()">å¯¼å‡ºå®¡è®¡æ—¥å¿—</button>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, query, orderBy, limit, onSnapshot, where, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase é…ç½® (è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„é…ç½®ï¼Œå¦åˆ™æ— æ³•è¿æ¥æ•°æ®åº“)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ç³»ç»Ÿå…¨å±€çŠ¶æ€
        window.State = {
            user: { id: "Peter_YT_Bilibili", nick: "Peter" }, // ç¤ºä¾‹ï¼Œå®é™…åº”ä»ç™»å½•è·å–
            isAdmin: true, 
            isMod: false
        };

        /* ============================================================
           SECTION: æ ¸å¿ƒ UI æ§åˆ¶å™¨ (UI Controller)
           ============================================================ */
        window.UI = {
            open: (id) => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'flex';
            },
            close: (id) => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'none';
            },
            render: (id, html) => {
                const el = document.getElementById(id);
                if(el) el.innerHTML = html;
            }
        };

        window.Kernel = {
            pushLog: (msg, type = "INFO") => {
                console.log(`[${type}] ${msg}`);
            }
        };

        /* ============================================================
           SECTION: è¶…çº§ç®¡ç†å‘˜æ§åˆ¶å°é€»è¾‘ (Admin Console)
           ============================================================ */
        window.Admin = {
            toggleMaintenance: async () => {
                if (!State.isAdmin) return alert("æƒé™æ‹’ç»");
                const ref = doc(db, "system", "config");
                const snap = await getDoc(ref);
                const current = snap.exists() ? snap.data().status : "ONLINE";
                const next = current === "ONLINE" ? "MAINTENANCE" : "ONLINE";
                await setDoc(ref, { status: next, operator: State.user.nick }, { merge: true });
                alert(`ç³»ç»Ÿå·²åˆ‡æ¢è‡³: ${next}`);
            },
            banPlayer: async () => {
                const tid = prompt("ç›®æ ‡ UID:");
                if (!tid) return;
                await updateDoc(doc(db, "users", tid), { banned: true, banBy: State.user.nick });
                alert("å°ç¦æˆåŠŸ");
            },
            modPlayerXP: async () => {
                const tid = prompt("ç›®æ ‡ UID:");
                const amt = parseInt(prompt("æ•°å€¼:"));
                if (!tid || isNaN(amt)) return;
                await updateDoc(doc(db, "users", tid), { xp: increment(amt) });
                alert("XP æ³¨å…¥å®Œæˆ");
            },
            exportAuditLog: async () => {
                const sn = await getDocs(collection(db, "action_logs"));
                let txt = "AUDIT LOG\n";
                sn.forEach(d => txt += JSON.stringify(d.data()) + "\n");
                const blob = new Blob([txt], {type: "text/plain"});
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = "audit.txt";
                a.click();
            }
        };

        /* ============================================================
           SECTION: è£èª‰æ¦œé€»è¾‘ (SurvivalRank)
           ============================================================ */
        window.SurvivalRank = {
            load: () => {
                UI.open('rank-modal');
                const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(30));
                onSnapshot(q, (sn) => {
                    let html = `<h2 class="neon-text">ğŸ† XP_LEADERBOARD</h2>`;
                    sn.forEach(d => {
                        const u = d.data();
                        html += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222;">
                                    <span>${u.nick}</span>
                                    <span style="color:var(--neon-green)">${u.xp || 0} XP</span>
                                 </div>`;
                    });
                    UI.render('rank-list-content', html);
                });
            }
        };
        /* ============================================================
           SECTION: æ¯æ—¥è¡¥ç»™ (Supply System)
           ============================================================ */
        window.Supply = {
            claim: async () => {
                try {
                    const ref = doc(db, "users", State.user.id);
                    const snap = await getDoc(ref);
                    const data = snap.exists() ? snap.data() : { lastSupply: 0, cycleDay: 0 };
                    
                    const now = Date.now();
                    if (now - (data.lastSupply || 0) < 86400000) {
                        const hours = Math.ceil((86400000 - (now - data.lastSupply)) / 3600000);
                        return alert(`åè®®å†·å´ä¸­ï¼šè¯·åœ¨ ${hours} å°æ—¶åå†æ¥ã€‚`);
                    }

                    await updateDoc(ref, {
                        lastSupply: now,
                        cycleDay: increment(1),
                        xp: increment(100)
                    });
                    alert("åŒæ­¥æˆåŠŸï¼100 XP å·²ä¸‹å‘è‡³ä½ çš„è´¦æˆ·ã€‚");
                } catch(e) { alert("è¡¥ç»™é¢†å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚"); }
            }
        };

        /* ============================================================
           SECTION: å†›å›¢ç™¾ç§‘ (Survival Wiki)
           ============================================================ */
        window.SurvivalWiki = {
            show: () => {
                UI.open('wiki-modal');
                UI.render('wiki-content', `
                    <div style="line-height:1.8;">
                        <h2 class="neon-text" style="border-bottom:1px solid var(--neon-blue); padding-bottom:10px;">ARCHIVE // æ¡£æ¡ˆåº“</h2>
                        <h3 style="color:var(--neon-red); margin-top:20px;">[ROOT] ç®¡ç†å±‚</h3>
                        <p>â— <b>IKUN5556</b> - æ ¸å¿ƒè´Ÿè´£äºº</p>
                        <p>â— <b>Peter_YT_Bilibili</b> - ç³»ç»Ÿæ¶æ„å¸ˆ</p>
                        <h3 style="color:var(--gold); margin-top:20px;">[LAW] ç”Ÿå­˜å®ˆåˆ™</h3>
                        <p>1. ä¸¥ç¦åœ¨äº¤æ˜“æ‰€å‘å¸ƒè™šå‡æŒ‚å•ã€‚</p>
                        <p>2. å°Šé‡æ‰€æœ‰ä¸­ç»§ç«™æˆå‘˜ï¼Œç¦æ­¢æ¶æ„åˆ·å±ã€‚</p>
                    </div>
                `);
            }
        };

        /* ============================================================
           SECTION: ç³»ç»Ÿåˆå§‹åŒ–å¯åŠ¨ (Bootstrap - æ ¸å¿ƒä¿®å¤)
           ============================================================ */
        function bootstrap() {
            if (!State.user) return;

            // 1. æ˜¾ç¤ºä¸»å®¹å™¨
            document.getElementById('app-root').style.display = 'block';
            
            // 2. æ¸²æŸ“é¡¶éƒ¨å¯¼èˆªçŠ¶æ€
            UI.render('nav-auth-slot', `
                <span style="color:var(--neon-blue); font-size:12px; margin-right:15px;">
                    CONNECTED::${State.user.id}
                </span>
                <button class="btn-rule danger" style="padding:5px 10px; font-size:10px;" onclick="location.reload()">æ–­å¼€</button>
            `);

            // 3. åŠ¨æ€æ³¨å…¥åŠŸèƒ½å¡ç‰‡ (è¿™æ˜¯è§£å†³é»‘å±çš„å…³é”®)
            const grid = document.getElementById('survival-grid-main');
            const modules = [
                { n: "æ¡£æ¡ˆåº“", d: "Wiki & è§„åˆ™æŸ¥è¯¢", c: "SurvivalWiki.show()", i: "ğŸ“š" },
                { n: "è£èª‰æ¦œ", d: "XP å…¨æœæ’å", c: "SurvivalRank.load()", i: "ğŸ†" },
                { n: "è¡¥ç»™ç«™", d: "æ¯æ—¥ç‰©èµ„åŒ…é¢†å–", c: "Supply.claim()", i: "ğŸ“¦" }
            ];

            // å¦‚æœæ˜¯ Peter æˆ– IKUNï¼Œé¢å¤–æ³¨å…¥ç®¡ç†å¡ç‰‡
            if (State.isAdmin) {
                modules.push({ n: "ç®¡ç†ç»ˆç«¯", d: "ç»´æŠ¤/å°ç¦/æ§åˆ¶å°", c: "UI.open('admin-modal')", i: "âš¡" });
            }

            grid.innerHTML = modules.map(m => `
                <div class="glass-card" onclick="${m.c}">
                    <div style="font-size:30px; margin-bottom:10px;">${m.i}</div>
                    <div style="color:var(--neon-blue); font-weight:bold; letter-spacing:1px;">${m.n}</div>
                    <div style="font-size:11px; color:#555; margin-top:5px;">${m.d}</div>
                </div>
            `).join('');

            console.log("SURVIVAL_RULES_V4: å¼•æ“å¯åŠ¨æˆåŠŸã€‚");
        }

        // ç¡®ä¿ DOM å’Œ Firebase åˆå§‹åŒ–å®Œæˆåå†å¯åŠ¨
        window.addEventListener('load', () => {
            setTimeout(bootstrap, 1000);
        });

    </script>
</body>
</html>
