<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生存法则 | COMMAND_HUB V2.5 旗舰版</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================================
           核心视觉协议：赛博网格与霓虹特效
           ============================================================ */
        :root {
            --neon-blue: #00f2ff;
            --neon-red: #ff0055;
            --neon-green: #39ff14;
            --bg-deep: #020508;
            --card-bg: rgba(10, 25, 41, 0.9);
            --border-glow: rgba(0, 242, 255, 0.3);
            --text-main: #e0faff;
            --font-tech: 'Orbitron', sans-serif;
            --font-body: 'Noto Sans SC', sans-serif;
        }

        body {
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-body);
            margin: 0;
            overflow-x: hidden;
            /* 严格要求的密集网格背景 */
            background-image: 
                linear-gradient(var(--border-glow) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-glow) 1px, transparent 1px);
            background-size: 35px 35px;
            background-attachment: fixed;
        }

        /* 全屏动态扫描线 */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 2px;
            background: rgba(0, 242, 255, 0.3);
            box-shadow: 0 0 15px var(--neon-blue);
            z-index: 10000;
            pointer-events: none;
            animation: scanline 8s linear infinite;
        }
        @keyframes scanline { 0% { top: -10%; } 100% { top: 110%; } }

        /* 顶部协议导航栏 */
        nav {
            height: 75px;
            background: rgba(5, 10, 20, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid var(--neon-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            position: sticky;
            top: 0;
            z-index: 2000;
            box-shadow: 0 5px 30px rgba(0, 242, 255, 0.2);
        }

        .logo {
            font-family: var(--font-tech);
            font-size: 1.6rem;
            letter-spacing: 5px;
            color: var(--neon-blue);
            text-shadow: 0 0 15px var(--neon-blue);
        }

        /* 模块网格容器 */
        .container {
            max-width: 1400px;
            margin: 50px auto;
            padding: 0 20px;
            animation: fadeIn 1.2s ease-out;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        .hub-title {
            text-align: center;
            font-family: var(--font-tech);
            font-size: 4.5rem;
            font-weight: 900;
            letter-spacing: 20px;
            margin-bottom: 70px;
            background: linear-gradient(to bottom, #fff, var(--neon-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 20px rgba(0,242,255,0.4));
        }

        /* 功能卡片样式 */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 35px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            padding: 55px 30px;
            position: relative;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            clip-path: polygon(25px 0, 100% 0, 100% calc(100% - 25px), calc(100% - 25px) 100%, 0 100%, 0 25px);
        }

        .card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-12px) scale(1.03);
            box-shadow: 0 15px 45px rgba(0, 242, 255, 0.25);
            background: rgba(0, 242, 255, 0.08);
        }

        .card h3 {
            font-family: var(--font-tech);
            color: var(--neon-blue);
            font-size: 1.4rem;
            margin-bottom: 18px;
            text-transform: uppercase;
        }

        .card p { font-size: 0.95rem; color: #a0c4cc; line-height: 1.7; }

        /* 模态框系统 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.96);
            z-index: 3000;
            backdrop-filter: blur(25px);
        }

        .modal-content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #040a12;
            border: 1px solid var(--neon-blue);
            width: 650px;
            max-width: 95vw;
            max-height: 85vh;
            overflow-y: auto;
            padding: 45px;
            box-shadow: 0 0 60px rgba(0, 242, 255, 0.15);
        }

        /* 按钮与输入框 */
        .btn {
            background: transparent;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 14px 28px;
            cursor: pointer;
            font-family: var(--font-tech);
            font-weight: 700;
            transition: 0.3s;
            clip-path: polygon(12px 0, 100% 0, 100% 70%, calc(100% - 12px) 100%, 0 100%, 0 30%);
            margin: 5px;
        }

        .btn:hover { background: var(--neon-blue); color: #000; box-shadow: 0 0 25px var(--neon-blue); }
        input { width: 100%; background: #000; border: 1px solid #1a3a4a; color: #fff; padding: 16px; margin-bottom: 22px; font-family: 'JetBrains Mono'; outline: none; box-sizing: border-box; }
        input:focus { border-color: var(--neon-blue); box-shadow: 0 0 10px rgba(0,242,255,0.3); }
    </style>
</head>
    <div id="global-chat-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">GLOBAL_BROADCAST // 全服大厅</h2>
        <div id="global-msgs-area" style="height:350px; overflow-y:auto; background:rgba(0,0,0,0.3); padding:15px; margin-bottom:20px; border:1px solid #1a3a4a;">
            </div>
        <button class="btn" style="width:100%" onclick="UI.close()">断开频道</button>
    </div>
</div>

<div id="market-modal" class="modal">
    <div class="modal-content" style="width:700px;">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">MARKET_PROTOCOL // 交易所</h2>
        <div style="background:rgba(0,242,255,0.05); padding:20px; border:1px solid #1a3a4a; margin-bottom:20px;">
            <div style="display:flex; gap:10px;">
                <input id="m-item-name" placeholder="物资名称" style="margin:0; flex:2;">
                <input id="m-item-price" type="number" placeholder="价格(XP)" style="margin:0; flex:1;">
                <button class="btn" style="margin:0;" onclick="Economy.listItem()">发布</button>
            </div>
        </div>
        <div id="market-list-area" style="max-height:400px; overflow-y:auto;">
            </div>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">关闭</button>
    </div>
</div>

<div id="rank-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">XP_RANKING // 荣誉榜</h2>
        <div id="rank-list-content" style="max-height:450px; overflow-y:auto;">
            </div>
        <button class="btn" style="margin-top:20px;" onclick="UI.close()">返回</button>
    </div>
</div>

<div id="supply-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">SUPPLY_SYNC // 物资同步</h2>
        <p style="color:#888; font-size:14px; margin-bottom:25px;">接入 24 小时冷却协议。连续同步 7 天可获得核心月石奖励。</p>
        <button class="btn" style="width:100%; padding:25px; font-size:1.2rem;" onclick="Supply.claim()">执行资源下发</button>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">取消</button>
    </div>
</div>

<div id="gift-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">GIFT_CODE // 密匙激活</h2>
        <input id="gift-code-input" placeholder="输入 8 位协议代码">
        <button class="btn" style="width:100%" onclick="Gifts.redeem()">确认激活</button>
        <div style="margin-top:15px; font-size:12px; color:#444;">有效识别符: IKUN666, 生存法则, 第一个登陆</div>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">返回</button>
    </div>
</div>

<div id="f-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">CONTACT_SEARCH // 检索</h2>
        <input id="search-uid" placeholder="输入目标 UID 建立波段连接">
        <button class="btn" style="width:100%" onclick="Social.searchAndChat()">发起加密会话</button>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">取消</button>
    </div>
</div>

<div id="wiki-modal" class="modal">
    <div class="modal-content">
        <div id="wiki-content"></div>
        <button class="btn" style="margin-top:20px;" onclick="UI.close()">确认已知</button>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-red);">ROOT_TERMINAL // 审计</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <button class="btn" style="border-color:var(--neon-red); color:var(--neon-red);" onclick="Logger.exportLogs()">导出行为日志 (TXT)</button>
            <button class="btn" style="border-color:var(--neon-red); color:var(--neon-red);" onclick="Admin.resetMarket()">重置全服交易</button>
            <button class="btn" style="border-color:var(--neon-red); color:var(--neon-red);" onclick="Admin.modXP()">远程注能 XP</button>
        </div>
        <button class="btn" style="margin-top:30px; width:100%;" onclick="UI.close()">退出控制台</button>
    </div>
</div>

<script>
    // 确保 Gifts 模块逻辑存在
    window.Gifts = {
        redeem: async () => {
            const input = document.getElementById('gift-code-input').value.trim();
            const codes = { "IKUN666": 100, "生存法则": 500, "第一个登陆": 200 };
            if (codes[input]) {
                alert("激活成功！XP 注入: " + codes[input]);
                // 此处可接续 Firebase 数据库更新逻辑
            } else {
                alert("密匙协议无效");
            }
        }
    };
</script>
<body>

<nav>
    <div class="logo">SURVIVAL_RULES // 核心中继</div>
    <div id="auth-ui">
        <button class="btn" onclick="UI.toggle('login-modal')">建立连接</button>
    </div>
</nav>

<div class="container" id="hub-root" style="display:none;">
    <div class="hub-title">COMMAND_HUB</div>
    <div class="grid" id="main-grid">
        </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">身份验证协议 // AUTH</h2>
        <input type="text" id="auth-uid" placeholder="玩家 UID (唯一识别码)">
        <input type="text" id="auth-nick" placeholder="核心昵称 (昵称)">
        <input type="password" id="auth-pw" placeholder="访问密码">
        <div style="display:flex; gap:15px;">
            <button class="btn" style="flex:1" onclick="Auth.login()">登录频道</button>
            <button class="btn" style="flex:1" onclick="Auth.register()">注册新协议</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, updateDoc, deleteDoc, increment, getDocs, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebase 配置
    const firebaseConfig = { 
        apiKey: "AIzaSyBC92jwiCLsfG6bE4k2Jo4KQSiI-A_gxII", 
        authDomain: "bloxd-survival.firebaseapp.com", 
        projectId: "bloxd-survival", 
        appId: "1:60666065786:web:bdc3131accaceb0180dcc3" 
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // 全局状态
    window.State = {
        user: JSON.parse(localStorage.getItem('SURVIVAL_USER')),
        isAdmin: false,
        activeChat: null
    };

    // UI 管理引擎 (统一管理所有弹窗和渲染)
    window.UI = {
        toggle: (id) => {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            const target = document.getElementById(id);
            if(target) target.style.display = 'block';
        },
        close: () => { document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); },
        render: (id, html) => { 
            const el = document.getElementById(id);
            if(el) el.innerHTML = html; 
        }
    };

    // 预定义的管理员名单
    const ADMINS = ["IKUN5556", "Peter_YT_Bilibili"];

    // 接下来将继续编写 Auth、Social、Economy 模块...
    /* ============================================================
   SECTION 2: 账户安全中心 (功能 9: 注册、登录、改名、销毁)
   ============================================================ */
window.Auth = {
    // 注册新协议
    register: async () => {
        const uid = document.getElementById('auth-uid').value.trim();
        const nick = document.getElementById('auth-nick').value.trim();
        const pw = document.getElementById('auth-pw').value;

        if (!uid || !nick || !pw) return alert("致命错误：协议字段缺失");

        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if (snap.exists()) return alert("冲突：该 UID 已被占用");

        await setDoc(ref, {
            id: uid, nick: nick, pw: pw,
            xp: 0, diamond: 0, usedCodes: [],
            lastSupply: 0, cycleDay: 0,
            regTime: serverTimestamp()
        });
        alert("协议注册成功，请执行登录");
    },

    // 登录系统
    login: async () => {
        const uid = document.getElementById('auth-uid').value.trim();
        const pw = document.getElementById('auth-pw').value;
        const snap = await getDoc(doc(db, "users", uid));

        if (snap.exists() && snap.data().pw === pw) {
            State.user = { id: uid, nick: snap.data().nick };
            localStorage.setItem('SURVIVAL_USER', JSON.stringify(State.user));
            location.reload();
        } else {
            alert("验证失败：凭据无效");
        }
    },

    // 退出连接
    logout: () => {
        localStorage.removeItem('SURVIVAL_USER');
        location.reload();
    }
};

/* ============================================================
   SECTION 3: 全球交易所引擎 (修复白色字与字符串 Bug)
   ============================================================ */
window.Economy = {
    loadMarket: () => {
        UI.toggle('market-modal');
        const q = query(collection(db, "market"), orderBy("time", "desc"));
        
        onSnapshot(q, (sn) => {
            const list = document.getElementById('market-list-area');
            if (!list) return;
            list.innerHTML = '';
            
            sn.forEach(d => {
                const item = d.data();
                const isMine = item.sellerId === State.user.id;
                
                // 采用拆分拼接法，彻底避免引号冲突
                const itemEl = document.createElement('div');
                itemEl.style.cssText = "border:1px solid " + (isMine ? "var(--neon-green)" : "#1a3a4a") + "; padding:15px; margin-bottom:10px; background:rgba(0,0,0,0.4); display:flex; justify-content:space-between; align-items:center;";
                
                const infoHtml = "<div><b style='color:var(--neon-blue)'>" + item.itemName + "</b><br><small style='color:#888'>卖家: " + item.sellerNick + " | 价格: " + item.price + " XP</small></div>";
                
                const btnHtml = isMine ? 
                    "<button class='btn' style='border-color:var(--neon-red); color:var(--neon-red); padding:5px' onclick=\"Economy.delItem('" + d.id + "')\">撤回</button>" : 
                    "<button class='btn' style='padding:5px' onclick=\"Social.initiatePrivateChat('" + item.sellerId + "','" + item.sellerNick + "')\">议价</button>";
                
                itemEl.innerHTML = infoHtml + "<div>" + btnHtml + "</div>";
                list.appendChild(itemEl);
            });
        });
    },

    listItem: async () => {
        const name = document.getElementById('m-item-name').value.trim();
        const price = parseInt(document.getElementById('m-item-price').value);
        if (!name || isNaN(price)) return alert("报文错误");

        await addDoc(collection(db, "market"), {
            sellerId: State.user.id,
            sellerNick: State.user.nick,
            itemName: name,
            price: price,
            time: serverTimestamp()
        });
        alert("已上架");
    },

    delItem: async (id) => {
        if (confirm("确定撤回？")) await deleteDoc(doc(db, "market", id));
    },

    // 荣誉榜逻辑
    loadRanks: () => {
        UI.toggle('rank-modal');
        const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(20));
        onSnapshot(q, (sn) => {
            let html = "";
            let i = 1;
            sn.forEach(d => {
                const u = d.data();
                html += "<div style='display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #222'><span>#" + (i++) + " " + u.nick + "</span><span style='color:var(--neon-green)'>" + (u.xp || 0) + " XP</span></div>";
            });
            UI.render('rank-list-content', html);
        });
    }
};

/* ============================================================
   SECTION 4: 核心初始化引导
   ============================================================ */
function initGrid() {
    const features = [
        { title: "管理终端 [ROOT]", desc: "最高权限审计。", action: "UI.toggle('admin-modal')", admin: true },
        { title: "通讯录协议", desc: "私信与加密频道。", action: "Social.openSearch()" },
        { title: "全服报文大厅", desc: "实时同步广播。", action: "UI.renderGlobalChat()" },
        { title: "荣誉贡献榜", desc: "XP 实时排名。", action: "Economy.loadRanks()" },
        { title: "每日补给同步", desc: "7日物资循环。", action: "UI.toggle('supply-modal')" },
        { title: "全球交易所", desc: "物资交换协议。", action: "Economy.loadMarket()" },
        { title: "密匙兑换中心", desc: "激活特殊礼包。", action: "UI.toggle('gift-modal')" },
        { title: "玩法与档案", desc: "查阅开发组档案。", action: "Wiki.show()" }
    ];

    const grid = document.getElementById('main-grid');
    if(!grid) return;
    grid.innerHTML = features.map(f => {
        if (f.admin && !State.isAdmin) return '';
        return "<div class='card' onclick=\"" + f.action + "\"><h3>" + f.title + "</h3><p>" + f.desc + "</p></div>";
    }).join('');
}

// 启动逻辑
if (State.user) {
    document.getElementById('hub-root').style.display = 'block';
    document.getElementById('auth-ui').innerHTML = "<span style='color:var(--neon-blue); margin-right:15px;'>ONLINE: " + State.user.nick + "</span><button class='btn' onclick='Auth.logout()'>断开</button>";
    if (ADMINS.includes(State.user.id) || ADMINS.includes(State.user.nick)) State.isAdmin = true;
    initGrid();
}
    /* ============================================================
   SECTION 5: 加密通讯协议 (私信系统)
   ============================================================ */
window.Social = {
    openSearch: () => UI.toggle('f-modal'),

    searchAndChat: async () => {
        const tid = document.getElementById('search-uid').value.trim();
        if (!tid || tid === State.user.id) return alert("UID 识别错误");
        const snap = await getDoc(doc(db, "users", tid));
        if (snap.exists()) {
            Social.initiatePrivateChat(tid, snap.data().nick);
        } else {
            alert("该波段未注册");
        }
    },

    initiatePrivateChat: (targetId, targetNick) => {
        UI.close();
        let win = document.getElementById('p-chat-window');
        if (!win) {
            win = document.createElement('div');
            win.id = 'p-chat-window';
            win.style.cssText = "position:fixed;bottom:20px;right:20px;width:350px;height:500px;background:#050d16;border:2px solid var(--neon-blue);display:flex;flex-direction:column;z-index:10000;";
            document.body.appendChild(win);
        }
        win.style.display = "flex";
        const chatId = [State.user.id, targetId].sort().join("_");
        
        win.innerHTML = `
            <div style="padding:10px;background:rgba(0,242,255,0.1);border-bottom:1px solid var(--neon-blue);display:flex;justify-content:space-between;">
                <span>LINK: ${targetNick}</span>
                <button onclick="this.parentElement.parentElement.style.display='none'" style="color:#fff;background:none;border:none;cursor:pointer;">×</button>
            </div>
            <div id="p-chat-msgs" style="flex:1;overflow-y:auto;padding:15px;background:rgba(0,0,0,0.5);"></div>
            <div style="padding:10px;display:flex;background:#000;">
                <input id="p-m-in" style="margin:0;flex:1;padding:5px;">
                <button id='p-send-btn' class='btn' style='margin:0;padding:5px;'>发送</button>
            </div>`;

        const q = query(collection(db, "messages"), where("chatId", "==", chatId), orderBy("time", "asc"), limit(50));
        if (window.unsubChat) window.unsubChat();
        window.unsubChat = onSnapshot(q, (sn) => {
            const box = document.getElementById('p-chat-msgs');
            if(!box) return;
            box.innerHTML = '';
            sn.forEach(d => {
                const m = d.data();
                const isMe = m.senderId === State.user.id;
                box.innerHTML += `<div style="text-align:${isMe?'right':'left'};margin-bottom:10px;">
                    <small style="color:#555">${m.senderNick}</small><br>
                    <span style="display:inline-block;padding:8px;background:${isMe?'#003333':'#222'};border:1px solid ${isMe? 'var(--neon-blue)':'#444'}">${m.text}</span>
                </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        document.getElementById('p-send-btn').onclick = async () => {
            const inp = document.getElementById('p-m-in');
            if(!inp.value) return;
            await addDoc(collection(db, "messages"), {
                chatId, senderId: State.user.id, senderNick: State.user.nick,
                text: inp.value, time: serverTimestamp()
            });
            inp.value = '';
        };
    }
};

/* ============================================================
   SECTION 6: 补给、日志与 Wiki
   ============================================================ */
window.Supply = {
    claim: async () => {
        const ref = doc(db, "users", State.user.id);
        const snap = await getDoc(ref);
        const data = snap.data();
        const now = Date.now();
        if (now - (data.lastSupply || 0) < 86400000) return alert("协议冷却中");

        const rewards = ["木头x64", "石头x64", "铁锭x32", "金锭x16", "钻石x8", "月石x2", "1000XP"];
        const day = data.cycleDay % 7;
        await updateDoc(ref, {
            lastSupply: now,
            cycleDay: increment(1),
            xp: increment(day === 6 ? 1000 : 50)
        });
        alert("获得补给: " + rewards[day]);
    }
};

window.Logger = {
    exportLogs: async () => {
        if (!State.isAdmin) return;
        const sn = await getDocs(query(collection(db, "action_logs"), limit(100)));
        let txt = "--- 行为审计日志 ---\n";
        sn.forEach(d => {
            const l = d.data();
            txt += `[${l.time?.toDate().toLocaleString()}] ${l.nick}: ${l.action}\n`;
        });
        const blob = new Blob([txt], {type: "text/plain"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "audit_log.txt";
        a.click();
    }
};

window.Wiki = {
    show: () => {
        UI.toggle('wiki-modal');
        UI.render('wiki-content', `
            <div style="text-align:left">
                <h3 style="color:var(--neon-blue)">// 生存档案 V2.5</h3>
                <p>腐竹: IKUN5556 | 创建者: Peter_YT_Bilibili</p>
                <hr>
                <p>1. 交易所所有物品均由玩家自行发布。</p>
                <p>2. 连续 7 天签到可获得月石奖励。</p>
            </div>
        `);
    }
};
</script>
  
