<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿå­˜æ³•åˆ™ Â· å®˜æ–¹æŒ‡æŒ¥éƒ¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. æ ¸å¿ƒè§†è§‰æ ·å¼ (CSS) --- */
        :root {
            --neon: #2ecc71;
            --bg: #05080a;
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(46, 204, 113, 0.2);
        }

        body {
            background: var(--bg);
            color: #e0e0e0;
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0;
            background-image: radial-gradient(circle at 50% -20%, #1a2c22 0%, var(--bg) 70%);
            min-height: 100vh;
        }

        /* å¯¼èˆªæ  */
        nav {
            background: rgba(10, 12, 16, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 15px 40px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .logo { font-family: 'Orbitron'; font-size: 24px; color: #fff; text-decoration: none; }
        .logo span { color: var(--neon); text-shadow: 0 0 10px var(--neon); }

        /* ä¸»å®¹å™¨ */
        .container { max-width: 1200px; margin: 0 auto; padding: 40px 20px; text-align: center; }
        
        h1 { font-size: 48px; margin-bottom: 10px; color: #fff; }
        .subtitle { color: #888; margin-bottom: 50px; }

        /* åŠŸèƒ½ç£è´´ç½‘æ ¼ */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 40px 20px;
            backdrop-filter: blur(10px);
            transition: 0.3s;
            cursor: pointer;
        }

        .card:hover {
            border-color: var(--neon);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(46, 204, 113, 0.1);
        }

        .card h3 { color: var(--neon); font-size: 22px; margin: 15px 0; }
        .card p { font-size: 14px; color: #aaa; }

        /* å¼¹çª—æ ·å¼ */
        .modal {
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.85); z-index: 2000; backdrop-filter: blur(8px);
        }

        .modal-content {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #0d1117; border: 1px solid var(--border);
            border-radius: 24px; padding: 40px; width: 90%; max-width: 400px;
        }

        input {
            width: 100%; padding: 12px; margin: 10px 0; background: #05080a; 
            border: 1px solid #30363d; border-radius: 8px; color: white; box-sizing: border-box;
        }

        .btn {
            width: 100%; padding: 14px; background: var(--neon); color: #000; border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* èŠå¤©å®¤é¢æ¿ */
        #chat-panel {
            display: none; position: fixed; bottom: 30px; right: 30px; width: 350px; height: 500px;
            background: rgba(13, 17, 23, 0.95); border: 1px solid var(--neon);
            border-radius: 20px; flex-direction: column; overflow: hidden; z-index: 3000;
        }

        #chat-msgs { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: #1c2128; padding: 10px; border-radius: 8px; border-left: 3px solid var(--neon); }
        .msg b { color: var(--neon); display: block; font-size: 11px; }

        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body>

<nav>
    <a href="#" class="logo">SURVIVAL<span>RULES</span></a>
    <div id="auth-ui"></div>
</nav>

<div class="container">
    <h1>ç”Ÿå­˜æ³•åˆ™</h1>
    <p class="subtitle">æœé›†ç‰©èµ„ Â· å»ºç«‹å†›å›¢ Â· è‡ªç”±äº¤æ˜“ Â· é»„é‡‘é¹¿è§’</p>

    <div class="grid">
        <div class="card" onclick="toggle('chat-panel')">
            <div style="font-size: 40px;">ğŸ’¬</div>
            <h3>ç»„é˜Ÿå¤§å…</h3>
            <p>å®æ—¶åœ¨çº¿é¢‘é“ï¼Œå¯»æ‰¾ç”Ÿå­˜ä¼™ä¼´</p>
        </div>
        <div class="card" onclick="toggle('wiki-modal')">
            <div style="font-size: 40px;">ğŸ“œ</div>
            <h3>ç©æ³•æ‰‹å†Œ</h3>
            <p>å†›å›¢æŒ‡ä»¤ã€é“å…·æŠ€èƒ½å…¨æŒ‡å—</p>
        </div>
        <div class="card" onclick="toggle('market-modal')">
            <div style="font-size: 40px;">âš–ï¸</div>
            <h3>äº¤æ˜“è¡Œ</h3>
            <p>è‡ªä¸»ä¸Šæ¶/ä¸‹æ¶ï¼Œç‰©èµ„è‡ªç”±è´¸æ˜“</p>
        </div>
    </div>
</div>

<div id="auth-modal" class="modal">
    <div class="modal-content">
        <h2 id="auth-title">ç™»å½• / æ³¨å†Œ</h2>
        <input type="text" id="a-id" placeholder="ç”Ÿå­˜ ID (Unique ID)">
        <input type="text" id="a-nick" placeholder="æ˜µç§° (ä»…æ³¨å†Œéœ€è¦)">
        <input type="password" id="a-pw" placeholder="è®¿é—®å¯†ç ">
        <button class="btn" onclick="handleAuth()">åŒæ­¥èº«ä»½</button>
        <button class="btn" style="background:#333; color:#fff" onclick="toggle('auth-modal')">å…³é—­</button>
    </div>
</div>

<div id="wiki-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <h2 style="color:var(--neon)">ğŸ“œ å¹¸å­˜è€…æŒ‡å—</h2>
        <div style="text-align: left; font-size: 14px; line-height: 1.8;">
            <p><b>ğŸ›¡ï¸ å†›å›¢æ ¸å¿ƒæŒ‡ä»¤:</b><br>
            !åˆ›å»ºå†›å›¢ [å] | !é‚€è¯· [å] | !å›åŸºåœ°<br>
            <i>*å—ä¼¤å10ç§’å†…æ— æ³•ä¼ é€ï¼ˆæˆ˜æ–—é”å®šï¼‰</i></p>
            <p><b>âœ¨ ç‰¹æŠ€é“å…·:</b><br>
            <b>é»„é‡‘é¹¿è§’:</b> çˆ†å‘5ç§’ Lv.6 è·³è·ƒæå‡ä¸æé€ŸåŠ æˆã€‚</p>
        </div>
        <button class="btn" onclick="toggle('wiki-modal')">çŸ¥é“äº†</button>
    </div>
</div>

<div id="market-modal" class="modal">
    <div class="modal-content">
        <h2 style="color:var(--neon)">âš–ï¸ äº¤æ˜“ä¸­å¿ƒ</h2>
        <input type="text" id="m-name" placeholder="ç‰©å“åç§°">
        <input type="number" id="m-price" placeholder="ä»·æ ¼ (ç»¿å®çŸ³)">
        <button class="btn" onclick="postItem()">ç«‹å³ä¸Šæ¶</button>
        <div id="market-list" style="margin-top:20px; max-height:200px; overflow-y:auto;"></div>
        <button class="btn" style="background:#333; color:#fff" onclick="toggle('market-modal')">å…³é—­</button>
    </div>
</div>

<div id="chat-panel">
    <div style="padding:15px; background:rgba(46, 204, 113, 0.1); display:flex; justify-content:space-between;">
        <span>ğŸŒ å®æ—¶é¢‘é“</span>
        <button onclick="toggle('chat-panel')" style="background:none; border:none; color:#fff; cursor:pointer;">âœ•</button>
    </div>
    <div id="chat-msgs"></div>
    <div style="padding:10px; display:flex; gap:5px;">
        <input type="text" id="m-input" placeholder="è¾“å…¥æ¶ˆæ¯..." style="margin:0;">
        <button onclick="sendMsg()" style="padding:0 15px; background:var(--neon); border:none; border-radius:8px; cursor:pointer;">å‘</button>
    </div>
</div>

<div id="toast-container"></div>

<script type="module">
    // --- 2. é€»è¾‘æ§åˆ¶ (JS) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBC92jwiCLsfG6bE4k2Jo4KQSiI-A_gxII",
        authDomain: "bloxd-survival.firebaseapp.com",
        projectId: "bloxd-survival",
        storageBucket: "bloxd-survival.firebasestorage.app",
        messagingSenderId: "60666065786",
        appId: "1:60666065786:web:bdc3131accaceb0180dcc3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    let user = JSON.parse(localStorage.getItem('SURVIVAL_USER_V1'));

    // UI åˆå§‹åŒ–
    window.toggle = (id) => {
        const el = document.getElementById(id);
        el.style.display = (el.style.display === 'flex' || el.style.display === 'block') ? 'none' : (id === 'chat-panel' ? 'flex' : 'block');
    };

    function updateAuthUI() {
        const ui = document.getElementById('auth-ui');
        if(user) {
            ui.innerHTML = `<span>${user.nick}</span> <button onclick="localStorage.clear();location.reload()" style="background:none; color:var(--neon); border:1px solid var(--neon); padding:5px 10px; border-radius:5px; margin-left:10px; cursor:pointer;">ç™»å‡º</button>`;
        } else {
            ui.innerHTML = `<button onclick="toggle('auth-modal')" style="background:var(--neon); border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">ç™»å½•/æ³¨å†Œ</button>`;
        }
    }

    // ç™»å½•æ³¨å†Œé€»è¾‘
    window.handleAuth = () => {
        const id = document.getElementById('a-id').value;
        const nick = document.getElementById('a-nick').value;
        const pw = document.getElementById('a-pw').value;
        
        if(!id || !pw) return alert("è¯·å¡«å†™IDå’Œå¯†ç ");
        
        // ç®€å•é€»è¾‘ï¼šå¦‚æœæœ¬åœ°æ²¡å­˜è¿‡è¯¥IDï¼Œè§†ä¸ºæ³¨å†Œï¼›å­˜è¿‡åˆ™åŒ¹é…å¯†ç 
        const saved = localStorage.getItem('DB_ID_' + id);
        if(!saved) {
            if(!nick) return alert("æ–°ç”¨æˆ·è¯·å¡«å†™æ˜µç§°");
            const data = { id, nick, pw };
            localStorage.setItem('DB_ID_' + id, JSON.stringify(data));
            user = data;
        } else {
            const data = JSON.parse(saved);
            if(data.pw !== pw) return alert("å¯†ç é”™è¯¯");
            user = data;
        }
        localStorage.setItem('SURVIVAL_USER_V1', JSON.stringify(user));
        location.reload();
    };

    // äº¤æ˜“è¡Œå®æ—¶é€»è¾‘
    window.postItem = async () => {
        if(!user) return alert("è¯·å…ˆç™»å½•");
        const name = document.getElementById('m-name').value;
        const price = document.getElementById('m-price').value;
        if(!name || !price) return;
        await addDoc(collection(db, "market"), { name, price, seller: user.nick, sellerId: user.id, createdAt: serverTimestamp() });
        alert("ä¸Šæ¶æˆåŠŸ");
    };

    onSnapshot(collection(db, "market"), (sn) => {
        const list = document.getElementById('market-list');
        list.innerHTML = '';
        sn.forEach(d => {
            const item = d.data();
            const div = document.createElement('div');
            div.style = "background:#161b22; padding:10px; border-radius:8px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center; border:1px solid #30363d";
            div.innerHTML = `<div><b>${item.name}</b><br><small>ğŸ’ ${item.price}</small></div>
                ${item.sellerId === user?.id ? `<button onclick="delItem('${d.id}')" style="background:#ff4757; border:none; color:#fff; border-radius:4px; padding:5px 10px; cursor:pointer">ä¸‹æ¶</button>` : `<small style="color:#666">${item.seller}</small>`}`;
            list.appendChild(div);
        });
    });

    window.delItem = async (id) => { await deleteDoc(doc(db, "market", id)); };

    // èŠå¤©é€»è¾‘
    window.sendMsg = async () => {
        if(!user) return alert("è¯·å…ˆç™»å½•");
        const input = document.getElementById('m-input');
        if(!input.value) return;
        await addDoc(collection(db, "messages"), { text: input.value, user: user.nick, createdAt: serverTimestamp() });
        input.value = '';
    };

    onSnapshot(query(collection(db, "messages"), orderBy("createdAt", "asc"), limit(50)), (sn) => {
        const box = document.getElementById('chat-msgs');
        box.innerHTML = '';
        sn.forEach(d => {
            const m = d.data();
            const div = document.createElement('div'); div.className = 'msg';
            div.innerHTML = `<b>${m.user}</b> ${m.text}`; box.appendChild(div);
        });
        box.scrollTop = box.scrollHeight;
    });

    updateAuthUI();
</script>
</body>
</html>
