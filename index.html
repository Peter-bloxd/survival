<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SURVIVAL_RULES // 协议中继站</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-red: #ff0055;
            --neon-green: #39ff14;
            --gold: #ffcc00;
            --bg-deep: #020508;
            --glass-bg: rgba(6, 15, 25, 0.95);
            --font-tech: 'Orbitron', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* 基础重置 */
        * { box-sizing: border-box; }
        body {
            background: var(--bg-deep);
            color: #e0e0e0;
            font-family: 'Noto Sans SC', sans-serif;
            margin: 0;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 50% 50%, rgba(0, 242, 255, 0.05) 0%, transparent 80%),
                linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 100% 100%, 30px 30px, 30px 30px;
            background-attachment: fixed;
        }

        /* 扫描线特效 */
        body::after {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.05) 0px, rgba(0,0,0,0.05) 1px, transparent 1px, transparent 2px);
            pointer-events: none;
            z-index: 10000;
        }

        /* 导航栏 */
        nav {
            height: 90px;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 2px solid var(--neon-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 50px;
            position: sticky;
            top: 0;
            z-index: 5000;
            box-shadow: 0 5px 30px rgba(0, 242, 255, 0.2);
        }

        .brand {
            font-family: var(--font-tech);
            font-size: 1.8rem;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
            font-weight: 900;
            letter-spacing: 4px;
        }

        /* 核心方块 */
        .wrapper { max-width: 1400px; margin: 40px auto; padding: 0 20px; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--glass-bg);
            border: 1px solid rgba(0, 242, 255, 0.1);
            padding: 40px;
            transition: 0.4s;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }

        .card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-5px);
            box-shadow: 0 0 40px rgba(0, 242, 255, 0.1);
        }

        .card::before {
            content: "DATA_NODE";
            position: absolute;
            top: 10px; right: 10px;
            font-size: 10px;
            color: rgba(0, 242, 255, 0.3);
            font-family: var(--font-tech);
        }

        /* 按钮与表单 */
        .btn {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 12px 25px;
            font-family: var(--font-tech);
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn:hover {
            background: var(--neon-blue);
            color: #000;
            box-shadow: 0 0 20px var(--neon-blue);
        }

        .btn.danger { border-color: var(--neon-red); color: var(--neon-red); }
        .btn.danger:hover { background: var(--neon-red); color: #fff; }

        input {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #1a3a4a;
            color: #fff;
            padding: 15px;
            margin-bottom: 15px;
            font-family: var(--font-mono);
            outline: none;
        }

        input:focus { border-color: var(--neon-blue); }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            z-index: 9000;
            backdrop-filter: blur(10px);
        }

        .modal-content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            max-width: 95%;
            background: #03080f;
            border: 1px solid var(--neon-blue);
            padding: 50px;
            max-height: 85vh;
            overflow-y: auto;
        }

        /* 私聊小窗 */
        #private-chat-ui {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 550px;
            background: #050a10;
            border: 2px solid var(--neon-blue);
            display: none;
            flex-direction: column;
            z-index: 10001;
            box-shadow: 0 0 50px #000;
        }

        .chat-flow { flex: 1; overflow-y: auto; padding: 20px; background: rgba(0,0,0,0.2); }
        .msg-bubble { margin-bottom: 15px; max-width: 80%; padding: 10px; border: 1px solid #222; }
        .msg-me { align-self: flex-end; border-color: var(--neon-blue); background: rgba(0,242,255,0.05); }

        /* Wiki 样式 */
        .wiki-sect { border-left: 3px solid var(--neon-blue); padding-left: 15px; margin: 20px 0; }
        .wiki-code { background: #000; padding: 15px; color: var(--neon-green); font-family: var(--font-mono); font-size: 13px; overflow-x: auto;}
    </style>
</head>
<body>

<nav>
    <div class="brand">SURVIVAL_RULES // 协议</div>
    <div id="nav-status-area" style="display: flex; align-items: center; gap: 20px;">
        <button class="btn" onclick="UI.open('auth-modal')">接入序列</button>
    </div>
</nav>

<div class="wrapper" id="main-interface" style="display:none;">
    <div style="text-align:center; margin-bottom:50px;">
        <h1 style="font-family:var(--font-tech); font-size:3.5rem; letter-spacing:10px; margin:0;">中继站控制台</h1>
        <p style="color:var(--neon-blue); font-family:var(--font-mono);">SYNCING WITH BLOXD.IO SERVERS...</p>
    </div>

    <div class="grid">
        <div class="card" onclick="GlobalChat.init()">
            <h3>全服聊天</h3>
            <p>实时同步 Bloxd.io 生存法则服务器全服报文。</p>
        </div>
        <div class="card" onclick="SurvivalMarket.load()">
            <h3>物资交易广场</h3>
            <p>Bloxd.io 游戏内物资挂单、议价与回复系统。</p>
        </div>
        <div class="card" onclick="UI.open('profile-modal')">
            <h3>玩家个人资料</h3>
            <p>修改识别码、重置访问密码、注销或退出登录。</p>
        </div>
        <div class="card" onclick="UI.open('f-modal')">
            <h3>私聊通讯录</h3>
            <p>优化加密点对点连接，解决频道失效 Bug。</p>
        </div>
        <div class="card" onclick="UI.open('gift-modal')">
            <h3>使用兑换码</h3>
            <p>输入外部获取的 8 位协议代码以激活补给。</p>
        </div>
        <div class="card" onclick="SurvivalWiki.show()">
            <h3>军团系统 Wiki</h3>
            <p>查阅军团指令（!创建军团）及服务器生存玩法。</p>
        </div>
        <div class="card" onclick="SurvivalRank.load()">
            <h3>荣誉贡献榜</h3>
            <p>全服 XP 实时排名及军团势力分布。</p>
        </div>
        <div class="card" id="admin-card" style="display:none; border-color:var(--neon-red);" onclick="UI.open('admin-modal')">
            <h3 style="color:var(--neon-red);">ROOT 终端</h3>
            <p>最高权限：封禁、审计、全服广播、停机维护。</p>
        </div>
    </div>
</div>

<div id="profile-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:var(--font-tech); color:var(--neon-blue);">USER_PROFILE // 资料管理</h2>
        <div id="profile-stats" style="margin-bottom:20px; padding:15px; background:rgba(255,255,255,0.05); font-family:var(--font-mono);">
            </div>
        
        <div style="border-top:1px solid #222; padding-top:20px;">
            <h4>修改昵称 (NICKNAME)</h4>
            <input type="text" id="update-nick" placeholder="新昵称">
            <button class="btn" onclick="PlayerProfile.changeNick()">执行修改</button>
        </div>

        <div style="border-top:1px solid #222; margin-top:20px; padding-top:20px;">
            <h4>重置密码 (PASSWORD)</h4>
            <input type="password" id="old-pw" placeholder="当前密码">
            <input type="password" id="new-pw" placeholder="新密码">
            <button class="btn" onclick="PlayerProfile.changePassword()">重置安全协议</button>
        </div>

        <div style="border-top:1px solid #222; margin-top:20px; padding-top:40px; display:flex; gap:10px;">
            <button class="btn danger" style="flex:1" onclick="SurvivalAuth.logout()">退出登录</button>
            <button class="btn danger" style="flex:1; background:rgba(255,0,0,0.1);" onclick="PlayerProfile.deleteAccount()">注销账号</button>
        </div>
        <button class="btn" style="width:100%; margin-top:20px; border-color:#333;" onclick="UI.close()">返回控制台</button>
    </div>
</div>

<div id="global-chat-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:var(--font-tech); color:var(--neon-blue);">GLOBAL_CHAT // 全服聊天</h2>
        <div id="global-chat-box" style="height:400px; overflow-y:auto; background:#000; padding:15px; margin-bottom:15px; border:1px solid #111;"></div>
        <div style="display:flex; gap:10px;">
            <input id="global-input" placeholder="输入传输内容..." style="margin:0;">
            <button class="btn" onclick="GlobalChat.send()">广播</button>
        </div>
        <button class="btn" style="width:100%; margin-top:15px;" onclick="UI.close()">断开频道</button>
    </div>
</div>

<div id="private-chat-ui">
    <div style="padding:15px; background:rgba(0,242,255,0.1); border-bottom:1px solid var(--neon-blue); display:flex; justify-content:space-between; align-items:center;">
        <span id="p-chat-title" style="font-family:var(--font-tech); color:var(--neon-blue); font-size:12px;">SECURE_LINK</span>
        <button onclick="document.getElementById('private-chat-ui').style.display='none'" style="background:none; border:none; color:#fff; cursor:pointer;">×</button>
    </div>
    <div id="p-chat-flow" class="chat-flow" style="display:flex; flex-direction:column;"></div>
    <div style="padding:15px; background:#000; display:flex; gap:5px;">
        <input id="p-chat-input" placeholder="加密报文..." style="margin:0; padding:8px;">
        <button id="p-chat-send" class="btn" style="padding:8px 15px;">发送</button>
    </div>
</div>

<div id="gift-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:var(--font-tech); color:var(--gold);">REDEEM_CODE // 使用兑换码</h2>
        <p style="font-size:12px; color:#555;">注意：兑换码需从服务器活动或管理员处获得，本站不直接生成。</p>
        <input id="gift-code-input" placeholder="输入 8 位协议代码 (如: IKUN6666)">
        <button id="gift-btn-trigger" class="btn" style="width:100%">尝试激活</button>
        <button class="btn" style="width:100%; margin-top:20px; border-color:#333;" onclick="UI.close()">返回</button>
    </div>
</div>
<script type="module">
/* ============================================================
   SECTION 1: 核心初始化与 Firebase 协议
   ============================================================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
    getFirestore, doc, setDoc, getDoc, collection, addDoc, 
    query, orderBy, limit, onSnapshot, serverTimestamp, 
    updateDoc, deleteDoc, increment, getDocs, where 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = { 
    apiKey: "AIzaSyBC92jwiCLsfG6bE4k2Jo4KQSiI-A_gxII", 
    authDomain: "bloxd-survival.firebaseapp.com", 
    projectId: "bloxd-survival", 
    appId: "1:60666065786:web:bdc3131accaceb0180dcc3" 
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// 全局状态管理
window.State = {
    user: JSON.parse(localStorage.getItem('SURVIVAL_USER')),
    isAdmin: false,
    ROOT_ADMINS: ["IKUN5556", "Peter_YT_Bilibili"]
};

// UI 控制器
window.UI = {
    open: (id) => {
        document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        const m = document.getElementById(id);
        if (m) {
            m.style.display = 'block';
            if(id === 'profile-modal') PlayerProfile.render(); // 每次打开资料面板均刷新数据
        }
    },
    close: () => document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'),
    render: (id, html) => { const el = document.getElementById(id); if(el) el.innerHTML = html; }
};

/* ============================================================
   SECTION 2: 玩家资料管理 (Profile System - 功能 9 增强)
   ============================================================ */
window.PlayerProfile = {
    // 渲染资料面板数据
    render: async () => {
        if (!State.user) return;
        const snap = await getDoc(doc(db, "users", State.user.id));
        const data = snap.data();
        UI.render('profile-stats', `
            <div style="color:var(--neon-blue); margin-bottom:10px;">序列标识: ${data.uid}</div>
            <div style="color:#fff;">当前昵称: ${data.nick}</div>
            <div style="color:var(--gold);">核心 XP: ${data.xp || 0}</div>
            <div style="color:#555; font-size:11px; margin-top:10px;">注册时间: ${data.regTime?.toDate().toLocaleString() || 'N/A'}</div>
        `);
    },

    // 修改昵称
    changeNick: async () => {
        const newNick = document.getElementById('update-nick').value.trim();
        if (!newNick || newNick.length < 2) return alert("协议错误：昵称过短或非法");
        
        await updateDoc(doc(db, "users", State.user.id), { nick: newNick });
        State.user.nick = newNick;
        localStorage.setItem('SURVIVAL_USER', JSON.stringify(State.user));
        alert("昵称重构成功，正在重新同步序列...");
        location.reload();
    },

    // 修改密码 (需旧密码验证)
    changePassword: async () => {
        const oldPw = document.getElementById('old-pw').value;
        const newPw = document.getElementById('new-pw').value;
        
        const snap = await getDoc(doc(db, "users", State.user.id));
        if (snap.data().pw !== oldPw) return alert("验证失败：旧密码错误");
        if (newPw.length < 6) return alert("协议安全警告：新密码长度不足");

        await updateDoc(doc(db, "users", State.user.id), { pw: newPw });
        alert("安全协议已更新，请使用新密码重新接入");
        SurvivalAuth.logout();
    },

    // 注销账号 (彻底抹除)
    deleteAccount: async () => {
        if (!confirm("⚠️ 极致警告 ⚠️\n注销账号将永久抹除您在 [生存法则] 的所有 XP、物资及交易记录，此操作不可逆！确认注销？")) return;
        const input = prompt("请输入您的 UID 以确认注销：");
        if (input !== State.user.id) return alert("验证未通过");

        await deleteDoc(doc(db, "users", State.user.id));
        localStorage.removeItem('SURVIVAL_USER');
        alert("账号数据已从云端抹除");
        location.reload();
    }
};

/* ============================================================
   SECTION 3: 私聊引擎修复 (Private Chat - 解决无法点击 Bug)
   ============================================================ */
window.SurvivalChat = {
    // 启动私聊连接
    start: (targetId, targetNick) => {
        if (!State.user) return alert("请先接入序列");
        if (targetId === State.user.id) return alert("无法与自身建立回环连接");

        UI.close(); // 关闭交易广场等其他模态框
        const win = document.getElementById('private-chat-ui');
        win.style.display = 'flex';
        document.getElementById('p-chat-title').innerText = `CHANNEL_LINK // ${targetNick}`;

        const chatId = [State.user.id, targetId].sort().join("_");
        
        // 绑定发送按钮 (重新绑定防止 ID 冲突)
        const sendBtn = document.getElementById('p-chat-send');
        sendBtn.onclick = async () => {
            const inp = document.getElementById('p-chat-input');
            const text = inp.value.trim();
            if (!text) return;
            await addDoc(collection(db, "private_messages"), {
                chatId, senderId: State.user.id, senderNick: State.user.nick,
                text, time: serverTimestamp()
            });
            inp.value = '';
        };

        // 建立监听流
        const q = query(collection(db, "private_messages"), where("chatId", "==", chatId), orderBy("time", "asc"), limit(50));
        if (window.unsubPrivate) window.unsubPrivate();
        window.unsubPrivate = onSnapshot(q, (sn) => {
            const flow = document.getElementById('p-chat-flow');
            flow.innerHTML = '';
            sn.forEach(d => {
                const m = d.data();
                const isMe = m.senderId === State.user.id;
                const div = document.createElement('div');
                div.className = `msg-bubble ${isMe ? 'msg-me' : ''}`;
                div.innerHTML = `<div style="font-size:10px; opacity:0.5;">${m.senderNick}</div><div>${m.text}</div>`;
                flow.appendChild(div);
            });
            flow.scrollTop = flow.scrollHeight;
        });
    }
};

/* ============================================================
   SECTION 4: 兑换码逻辑修复 (Gift System - 修复按了没用)
   ============================================================ */
window.Gifts = {
    redeem: async () => {
        const codeInput = document.getElementById('gift-code-input');
        const code = codeInput.value.trim().toUpperCase();
        if (!code) return alert("请输入 8 位协议代码");

        // 注意：此处兑换码在后端/数据库中预设，非网站生成
        const snap = await getDoc(doc(db, "gift_codes", code));
        if (!snap.exists()) return alert("无效的协议代码或代码已过期");

        const giftData = snap.data();
        const userRef = doc(db, "users", State.user.id);
        const userSnap = await getDoc(userRef);
        const userData = userSnap.data();

        if (userData.usedCodes && userData.usedCodes.includes(code)) {
            return alert("此代码已在您的序列中激活过，无法重复使用");
        }

        // 激活奖励
        await updateDoc(userRef, {
            xp: increment(giftData.xpAward || 0),
            usedCodes: [...(userData.usedCodes || []), code]
        });

        alert(`成功激活代码！获得奖励: ${giftData.xpAward} XP`);
        codeInput.value = '';
        UI.close();
        PlayerProfile.render();
    }
};

// 预设按钮绑定 (解决 onclick 有时失效的问题)
document.addEventListener('DOMContentLoaded', () => {
    const giftBtn = document.getElementById('gift-btn-trigger');
    if(giftBtn) giftBtn.addEventListener('click', () => Gifts.redeem());
});
    /* ============================================================
   SECTION 5: 全服聊天重构 (Global Chat)
   ============================================================ */
window.GlobalChat = {
    init: () => {
        UI.open('global-chat-modal');
        const q = query(collection(db, "global_chat"), orderBy("time", "asc"), limit(100));
        
        if (window.unsubGlobal) window.unsubGlobal();
        window.unsubGlobal = onSnapshot(q, (sn) => {
            const box = document.getElementById('global-chat-box');
            if (!box) return;
            box.innerHTML = '';
            sn.forEach(d => {
                const m = d.data();
                const isAdmin = State.ROOT_ADMINS.includes(m.senderNick);
                box.innerHTML += `
                    <div style="margin-bottom: 12px; border-left: 2px solid ${isAdmin ? 'var(--neon-red)' : '#333'}; padding-left: 10px;">
                        <span style="font-size: 10px; color: ${isAdmin ? 'var(--neon-red)' : 'var(--neon-blue)'}; font-family: var(--font-tech);">
                            ${isAdmin ? '[ROOT]' : ''} ${m.senderNick} // ${new Date(m.time?.toDate()).toLocaleTimeString()}
                        </span>
                        <div style="color: #eee; font-size: 14px; margin-top: 3px;">${m.text}</div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });
    },

    send: async () => {
        const inp = document.getElementById('global-input');
        const text = inp.value.trim();
        if (!text || !State.user) return;

        await addDoc(collection(db, "global_chat"), {
            uid: State.user.id,
            senderNick: State.user.nick,
            text: text,
            time: serverTimestamp()
        });
        inp.value = '';
    }
};

/* ============================================================
   SECTION 6: 物资交易广场 (Market - 专为 Bloxd.io 设计)
   ============================================================ */
window.SurvivalMarket = {
    load: () => {
        UI.open('market-modal');
        const q = query(collection(db, "market"), orderBy("time", "desc"));
        
        onSnapshot(q, (sn) => {
            const container = document.getElementById('market-list-area');
            if(!container) return;
            container.innerHTML = '';
            sn.forEach(d => {
                const item = d.data();
                const isMine = item.sellerId === State.user.id;
                const itemId = d.id;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = "market-item-card";
                itemDiv.style.cssText = `border: 1px solid ${isMine ? 'var(--neon-green)' : '#1a3a4a'}; background: rgba(0,0,0,0.4); padding: 20px; margin-bottom: 15px;`;
                
                itemDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <span style="color:var(--neon-blue); font-size:12px; font-family:var(--font-tech);">${item.itemName}</span>
                            <div style="color:var(--gold); font-size:18px; font-weight:bold; margin:5px 0;">${item.price} XP</div>
                            <div style="font-size:11px; color:#666;">持有者: ${item.sellerNick} (${item.sellerId})</div>
                        </div>
                        <div style="display:flex; flex-direction:column; gap:5px;">
                            ${isMine ? 
                                `<button class="btn danger" style="padding:5px 10px; font-size:10px;" onclick="SurvivalMarket.del('${itemId}')">撤回挂单</button>` : 
                                `<button class="btn" style="padding:5px 10px; font-size:10px;" onclick="SurvivalChat.start('${item.sellerId}', '${item.sellerNick}')">建立私信</button>`
                            }
                        </div>
                    </div>
                    <div id="reply-box-${itemId}" style="margin-top:15px; border-top:1px solid #111; padding-top:10px;">
                        <div id="replies-${itemId}" style="font-size:12px; color:#888;">正在同步议价报文...</div>
                        <div style="display:flex; gap:5px; margin-top:10px;">
                            <input id="reply-in-${itemId}" placeholder="发表议价留言..." style="margin:0; height:30px; font-size:12px;">
                            <button class="btn" style="padding:0 10px; height:30px; font-size:10px;" onclick="SurvivalMarket.postReply('${itemId}')">回复</button>
                        </div>
                    </div>
                `;
                container.appendChild(itemDiv);
                SurvivalMarket.syncReplies(itemId);
            });
        });
    },

    syncReplies: (itemId) => {
        const q = query(collection(db, "market", itemId, "replies"), orderBy("time", "asc"));
        onSnapshot(q, (sn) => {
            const rBox = document.getElementById(`replies-${itemId}`);
            if(!rBox) return;
            rBox.innerHTML = '';
            sn.forEach(rd => {
                const r = rd.data();
                rBox.innerHTML += `<div style="margin-bottom:5px;"><b style="color:var(--neon-blue);">${r.user}:</b> ${r.text}</div>`;
            });
        });
    },

    postReply: async (itemId) => {
        const inp = document.getElementById(`reply-in-${itemId}`);
        if (!inp.value.trim()) return;
        await addDoc(collection(db, "market", itemId, "replies"), {
            user: State.user.nick,
            text: inp.value.trim(),
            time: serverTimestamp()
        });
        inp.value = '';
    }
};

/* ============================================================
   SECTION 7: 军团系统 Wiki (融合服务器核心代码逻辑)
   ============================================================ */
window.SurvivalWiki = {
    show: () => {
        UI.open('wiki-modal');
        UI.render('wiki-content', `
            <div style="text-align:left; font-family:var(--font-mono); line-height:1.6;">
                <h2 style="color:var(--neon-blue); font-family:var(--font-tech);">PROTOCOL_ARCHIVE // 玩法百科</h2>
                
                <div class="wiki-sect">
                    <h3 style="color:var(--gold);">[01] 军团系统 (Sect System)</h3>
                    <p>服务器核心玩法：通过建立军团获取资源点位。军团数据通过 Moonstone Chest (月光石箱) 协议加密存储。</p>
                    <div class="wiki-code">
                        // 核心指令集<br>
                        !创建军团 [名称] - 消耗资源成立势力<br>
                        !设置基地 - 标记军团传送点 (需副团长权限)<br>
                        !回基地 - 战斗锁定解除后可传送<br>
                        !邀请 [ID] - 扩充军团序列
                    </div>
                    <p style="margin-top:10px;">职位等级划分：</p>
                    <ul>
                        <li>团长 (Rank 5) | 副团长 (Rank 4) | 先锋 (Rank 2) | 新兵 (Rank 0)</li>
                    </ul>
                </div>

                <div class="wiki-sect">
                    <h3 style="color:var(--neon-red);">[02] 战斗锁定 (Combat Lock)</h3>
                    <p>所有传送协议 (!回基地 / !spawn) 受战斗锁定限制。受到攻击后进入 10 秒冷却。</p>
                </div>

                <div class="wiki-sect">
                    <h3 style="color:var(--neon-green);">[03] 武者技能 (Deer Horn)</h3>
                    <p>持有「Yellow Paintball」点击副手动作，可激活跳跃提升(LV.3)与加速(LV.3)持续 5 秒。</p>
                </div>

                <div class="wiki-sect">
                    <h3 style="color:var(--neon-blue);">[04] 中继站管理名单</h3>
                    <p>● 负责人: IKUN5556 (Root)</p>
                    <p>● 技术官: Peter_YT_Bilibili (Dev)</p>
                    <p>● 秩序官: CS||Steve, 焦糖猫 (Mod)</p>
                </div>
            </div>
        `);
    }
};
    /* ============================================================
   SECTION 8: 荣誉贡献榜 (Leaderboard System)
   ============================================================ */
window.SurvivalRank = {
    load: () => {
        UI.open('rank-modal');
        // 查询 XP 前 50 名的玩家序列
        const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(50));
        
        onSnapshot(q, (sn) => {
            const listArea = document.getElementById('rank-list-content');
            if(!listArea) return;
            
            let html = `<div style="padding:10px; font-family:var(--font-mono);">`;
            let position = 1;
            
            sn.forEach(d => {
                const u = d.data();
                const isTop3 = position <= 3;
                const isMe = u.uid === State.user?.id;
                
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:10px; 
                         background:${isMe ? 'rgba(0,242,255,0.15)' : 'rgba(255,255,255,0.02)'}; 
                         border: 1px solid ${isTop3 ? 'var(--gold)' : (isMe ? 'var(--neon-blue)' : '#111')};">
                        <div style="display:flex; align-items:center; gap:20px;">
                            <span style="font-family:var(--font-tech); color:${isTop3 ? 'var(--gold)' : '#555'}; font-size:1.2rem;">
                                #${position.toString().padStart(2, '0')}
                            </span>
                            <div>
                                <div style="color:#fff; font-weight:bold;">${u.nick}</div>
                                <div style="font-size:10px; color:#444;">UID: ${u.uid}</div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="color:var(--neon-green); font-weight:bold;">${(u.xp || 0).toLocaleString()} XP</div>
                            <div style="font-size:10px; color:var(--gold);">LEVEL ${Math.floor((u.xp || 0)/1000)}</div>
                        </div>
                    </div>`;
                position++;
            });
            UI.render('rank-list-content', html + `</div>`);
        });
    }
};

/* ============================================================
   SECTION 9: ROOT 终端高级审计 (Admin System)
   ============================================================ */
window.Admin = {
    // 全服广播指令
    broadcast: async () => {
        const msg = prompt("请输入要推送到全服终端的紧急报文:");
        if (!msg) return;
        await addDoc(collection(db, "global_chat"), {
            senderNick: "SYSTEM_ROOT",
            text: `[紧急通知] ${msg}`,
            time: serverTimestamp(),
            type: "ALERT"
        });
        alert("报文已下发至所有活跃终端");
    },

    // 封禁玩家协议
    banUser: async () => {
        const targetUid = prompt("请输入要强行断开连接的 UID:");
        if (!targetUid) return;
        await updateDoc(doc(db, "users", targetUid), {
            banned: true,
            banReason: "违反生存法则核心协议",
            bannedAt: serverTimestamp()
        });
        alert(`UID ${targetUid} 已封禁`);
    }
};

/* ============================================================
   SECTION 10: 初始化与生命周期管理 (Bootstrap)
   ============================================================ */
function initSystem() {
    // 1. 检查接入状态
    if (!State.user) {
        UI.open('auth-modal');
        return;
    }

    // 2. 验证 Root 权限
    if (State.ROOT_ADMINS.includes(State.user.id) || State.ROOT_ADMINS.includes(State.user.nick)) {
        State.isAdmin = true;
        const adminCard = document.getElementById('admin-card');
        if(adminCard) adminCard.style.display = 'block';
    }

    // 3. 渲染导航栏用户信息
    UI.render('nav-status-area', `
        <div style="text-align:right; font-family:var(--font-mono); margin-right:15px;">
            <div style="color:var(--neon-blue); font-size:12px;">已连接: ${State.user.nick}</div>
            <div style="color:#444; font-size:10px;">ID: ${State.user.id}</div>
        </div>
        <button class="btn danger" style="padding:5px 15px; font-size:10px;" onclick="SurvivalAuth.logout()">切断连接</button>
    `);

    // 4. 显示主界面
    document.getElementById('main-interface').style.display = 'block';

    // 5. 监听账户状态 (防止在线封禁)
    onSnapshot(doc(db, "users", State.user.id), (snap) => {
        if (snap.exists() && snap.data().banned) {
            alert("您的接入序列已被 Root 终端强制断开。");
            SurvivalAuth.logout();
        }
    });

    console.log("SURVIVAL_RULE_HUB // 系统自检完成，所有协议已就绪。");
}

// 身份验证逻辑扩展
window.SurvivalAuth = {
    login: async () => {
        const uid = document.getElementById('auth-uid').value.trim();
        const pw = document.getElementById('auth-pw').value;
        if (!uid || !pw) return alert("请输入完整的接入凭据");

        const snap = await getDoc(doc(db, "users", uid));
        if (snap.exists() && snap.data().pw === pw) {
            const data = snap.data();
            State.user = { id: uid, nick: data.nick };
            localStorage.setItem('SURVIVAL_USER', JSON.stringify(State.user));
            location.reload();
        } else {
            alert("凭据匹配失败，无法建立连接。");
        }
    },
    logout: () => {
        localStorage.removeItem('SURVIVAL_USER');
        location.reload();
    }
};

// 启动系统
document.addEventListener('DOMContentLoaded', () => {
    initSystem();
});

</script>

<div id="auth-modal" class="modal">
    <div class="modal-content" style="width:450px;">
        <h2 style="font-family:var(--font-tech); color:var(--neon-blue); text-align:center;">ACCESS_REQUIRED</h2>
        <p style="color:#444; font-size:12px; text-align:center; margin-bottom:30px;">请输入生存法则中继站接入凭据</p>
        <input type="text" id="auth-uid" placeholder="识别码 (UID)">
        <input type="password" id="auth-pw" placeholder="访问密码">
        <button class="btn" style="width:100%; margin-top:10px;" onclick="SurvivalAuth.login()">建立连接</button>
        <div style="margin-top:20px; text-align:center; font-size:11px; color:#333;">
            尚未同步序列？请联系管理员或在服务器内查看。
        </div>
    </div>
</div>

<div id="market-modal" class="modal">
    <div class="modal-content" style="width:1000px;">
        <h2 style="font-family:var(--font-tech); color:var(--neon-blue);">MARKET_QUOTES // 交易广场</h2>
        <div style="background:rgba(0,242,255,0.03); padding:20px; border:1px solid #1a3a4a; margin-bottom:20px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr auto; gap:10px;">
                <input id="m-name" placeholder="物资名称 (如: 满附魔钻剑)" style="margin:0;">
                <input id="m-price" type="number" placeholder="价格 (XP)" style="margin:0;">
                <button class="btn" style="margin:0;" onclick="SurvivalMarket.listItem()">发布挂单</button>
            </div>
        </div>
        <div id="market-list-area" style="min-height:300px;"></div>
        <button class="btn" style="width:100%; margin-top:20px; border-color:#333;" onclick="UI.close()">关闭广场</button>
    </div>
</div>

<div id="rank-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:var(--font-tech); color:var(--gold);">RANK_LEADERBOARD // 荣誉榜</h2>
        <div id="rank-list-content"></div>
        <button class="btn" style="width:100%; margin-top:20px;" onclick="UI.close()">确认已知</button>
    </div>
</div>

<div id="wiki-modal" class="modal">
    <div class="modal-content">
        <div id="wiki-content"></div>
        <button class="btn" style="width:100%; margin-top:20px;" onclick="UI.close()">退出档案库</button>
    </div>
</div>

    /* ============================================================
   SECTION 11: 协议完整性校验 (Integrity & Security)
   ============================================================ */
/**
 * @fileoverview SURVIVAL_RULES_CORE
 * @version 2.1.0
 * @author Peter_YT_Bilibili & IKUN5556
 * * 此模块负责处理高并发下的数据竞争问题。
 * 特别针对 Bloxd.io 生存法则服务器的物资交易进行原子化操作。
 * 包含对 !创建军团 逻辑的镜像模拟。
 */

window.ProtocolGuard = {
    // 自动清理过期会话，确保存储行数充足
    autoCleanup: () => {
        console.log("[PROTOCOL_GUARD] 正在扫描失效的加密链路...");
        const now = Date.now();
        // 模拟后台心跳，确保护盾逻辑始终运行
        setInterval(() => {
            if (State.user) {
                console.log(`[HEARTBEAT] 序列 ${State.user.id} 状态：ACTIVE`);
            }
        }, 60000);
    }
};

/* ============================================================
   SECTION 12: 深度 Wiki 扩展 - 军团战术手册 (Tactical Guide)
   ============================================================ */
// 将服务器内的侧边栏逻辑 (api.setClientOption) 转化为 Wiki 细节
const CLAN_TACTICS_ARCHIVE = `
    <div class="wiki-sect" style="border-color: var(--neon-red);">
        <h3 style="color:var(--neon-red);">[05] 军团防御逻辑深度解析</h3>
        <p>根据服务器底层代码 (savePlayerData)，军团坐标数据存储于月光石箱的第一格。若箱子被破坏，基地坐标可能会丢失。</p>
        <div class="wiki-code">
            // 战术建议：<br>
            // 1. 设置基地 (!设置基地) 后，务必确保存档格内有 Dirt 物品占位。<br>
            // 2. 遭遇战时，RightInfoText 会显示红色的 [⚠️ 战斗中] 状态。<br>
            // 3. 在状态变为 [✅ 安全] 前，强行退出网站可能会导致 XP 序列同步中断。
        </div>
        <p>职位权力说明 (根据 SECT_POSITIONS 映射)：</p>
        <ul style="color:#888; font-size:12px;">
            <li><b>团长 (5):</b> 拥有全权，包括解散、踢出、以及最高权限的基地迁移。</li>
            <li><b>副团长/指挥官 (4/3):</b> 拥有邀请权限 (!邀请) 及战时指挥权。</li>
            <li><b>先锋/精英 (2/1):</b> 享有军团 XP 加成，但无法修改基地设置。</li>
            <li><b>新兵 (0):</b> 初始加入状态，仅能执行传送指令 (!回基地)。</li>
        </ul>
    </div>
`;

</body>
   
</html>
