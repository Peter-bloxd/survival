<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生存法则 | COMMAND_HUB V2.0 旗舰版</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* ============================================================
           核心样式：赛博网格与视觉特效
           ============================================================ */
        :root {
            --neon-blue: #00f2ff;
            --neon-red: #ff0055;
            --neon-green: #39ff14;
            --bg-deep: #020508;
            --card-bg: rgba(10, 25, 41, 0.85);
            --border-glow: rgba(0, 242, 255, 0.3);
            --text-main: #e0faff;
            --font-tech: 'Orbitron', sans-serif;
            --font-body: 'Noto Sans SC', sans-serif;
            --transition: 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-body);
            margin: 0;
            overflow-x: hidden;
            /* 严格要求的网格风格背景 */
            background-image: 
                linear-gradient(var(--border-glow) 1px, transparent 1px),
                linear-gradient(90deg, var(--border-glow) 1px, transparent 1px);
            background-size: 40px 40px;
            background-attachment: fixed;
        }

        /* 屏幕扫描线动画 */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.2) 50%);
            background-size: 100% 4px;
            z-index: 9999;
            pointer-events: none;
            opacity: 0.2;
            animation: scanline 10s linear infinite;
        }
        @keyframes scanline { 0% { background-position: 0 0; } 100% { background-position: 0 100%; } }

        /* 顶部导航协议栏 */
        nav {
            height: 70px;
            background: rgba(5, 10, 20, 0.9);
            backdrop-filter: blur(15px);
            border-bottom: 2px solid var(--neon-blue);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 50px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-logo {
            font-family: var(--font-tech);
            font-size: 1.4rem;
            letter-spacing: 4px;
            color: var(--neon-blue);
            text-shadow: 0 0 10px var(--neon-blue);
        }

        .container {
            max-width: 1400px;
            margin: 60px auto;
            padding: 0 30px;
        }

        .hub-header {
            text-align: center;
            font-family: var(--font-tech);
            font-size: 4rem;
            font-weight: 900;
            letter-spacing: 15px;
            margin-bottom: 80px;
            color: #fff;
            text-shadow: 0 0 20px var(--neon-blue);
        }

        /* 核心功能网格 */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 40px;
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-glow);
            padding: 60px 30px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }

        .card:hover {
            border-color: var(--neon-blue);
            transform: translateY(-10px);
            box-shadow: 0 0 30px rgba(0, 242, 255, 0.3);
            background: rgba(0, 242, 255, 0.05);
        }

        .card h3 {
            font-family: var(--font-tech);
            color: var(--neon-blue);
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .card.admin { border-color: var(--neon-red); }
        .card.admin h3 { color: var(--neon-red); }

        /* 模态框通用样式 */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            backdrop-filter: blur(15px);
        }

        .modal-content {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #050d16;
            border: 1px solid var(--neon-blue);
            width: 550px;
            max-width: 90vw;
            padding: 40px;
        }

        .btn {
            background: transparent;
            color: var(--neon-blue);
            border: 1px solid var(--neon-blue);
            padding: 12px 25px;
            cursor: pointer;
            font-family: var(--font-tech);
            transition: 0.3s;
            clip-path: polygon(10px 0, 100% 0, 100% 70%, calc(100% - 10px) 100%, 0 100%, 0 30%);
        }

        .btn:hover { background: var(--neon-blue); color: #000; }
        input { width: 100%; background: #000; border: 1px solid #1a3a4a; color: #fff; padding: 15px; margin-bottom: 20px; outline: none; }
    </style>
</head>
<body>

<nav>
    <div class="nav-logo">SURVIVAL_RULES //协议</div>
    <div id="auth-status">
        <button class="btn" onclick="UI.toggle('login-modal')">建立连接</button>
    </div>
</nav>

<div class="container" id="hub-root" style="display:none;">
    <div class="hub-header">COMMAND_HUB</div>
    
    <div class="grid">
        <div id="admin-module" class="card admin" style="display:none;" onclick="UI.toggle('admin-modal')">
            <h3>管理终端 [ROOT]</h3>
            <p>系统级审计、全服物资干预与玩家行为监管。</p>
        </div>

        <div class="card" onclick="Social.openContacts()">
            <h3>通讯录协议</h3>
            <p>私信、好友备注与点对点加密频道。</p>
        </div>

        <div class="card" onclick="UI.toggle('global-chat-modal')">
            <h3>全服报文大厅</h3>
            <p>公共频道实时同步，所有玩家可见。</p>
        </div>

        <div class="card" onclick="Economy.loadRanks()">
            <h3>荣誉贡献榜</h3>
            <p>XP 全球排行，实时同步数据。</p>
        </div>

        <div class="card" onclick="UI.toggle('supply-modal')">
            <h3>每日补给协议</h3>
            <p>7日物资下发策略，每日刷新。</p>
        </div>

        <div class="card" onclick="Economy.loadMarket()">
            <h3>全球交易所</h3>
            <p>物资上下架、议价与回复沟通。</p>
        </div>

        <div class="card" onclick="UI.toggle('gift-modal')">
            <h3>密匙兑换中心</h3>
            <p>IKUN666、生存法则、第一个登陆。</p>
        </div>

        <div class="card" onclick="UI.toggle('wiki-modal')">
            <h3>玩法与档案</h3>
            <p>腐竹 IKUN5556 与创建者团队信息。</p>
        </div>
    </div>
</div>

<div id="login-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">身份验证 // AUTH</h2>
        <input type="text" id="in-uid" placeholder="玩家 UID">
        <input type="text" id="in-nick" placeholder="玩家昵称">
        <input type="password" id="in-pw" placeholder="访问密码">
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="Auth.handleLogin()">登录系统</button>
            <button class="btn" onclick="Auth.handleRegister()">注册协议</button>
        </div>
    </div>
</div>

<script type="module">
    // 第一部分 JS 逻辑：初始化与管理员判定
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const config = { apiKey: "AIzaSyBC92jwiCLsfG6bE4k2Jo4KQSiI-A_gxII", authDomain: "bloxd-survival.firebaseapp.com", projectId: "bloxd-survival", appId: "1:60666065786:web:bdc3131accaceb0180dcc3" };
    const app = initializeApp(config);
    const db = getFirestore(app);

    window.State = {
        user: JSON.parse(localStorage.getItem('SURVIVAL_USER')),
        isAdmin: false
    };

    window.UI = {
        toggle: (id) => {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
            const el = document.getElementById(id);
            if(el) el.style.display = 'block';
        }
    };

    // 管理员 ID 定义 (功能点 8 所需)
    const ADMIN_LIST = ["IKUN5556", "Peter_YT_Bilibili"];

    async function checkAdmin() {
        if(State.user && (ADMIN_LIST.includes(State.user.id) || ADMIN_LIST.includes(State.user.nick))) {
            State.isAdmin = true;
            document.getElementById('admin-module').style.display = 'block';
        }
    }

    if(State.user) {
        document.getElementById('hub-root').style.display = 'block';
        document.getElementById('auth-status').innerHTML = `<span style="color:var(--neon-blue); margin-right:20px;">● ${State.user.nick}</span><button class="btn" onclick="Auth.logout()">断开连接</button>`;
        checkAdmin();
    }
</script>
/* ============================================================
   SECTION 2: 账户安全管理中心 (功能 9: 登录、注册、注销、改名)
   ============================================================ */
    
window.Auth = {
    // 协议注册：包含密码存储与初始数据结构
    handleRegister: async () => {
        const uid = document.getElementById('in-uid').value.trim();
        const nick = document.getElementById('in-nick').value.trim();
        const pw = document.getElementById('in-pw').value;
        if(!uid || !nick || !pw) return alert("致命错误：协议字段未对齐 (请填写完整)");

        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if(snap.exists()) return alert("冲突警告：该 UID 已被占用");

        // 初始化玩家档案 (修复功能 4: 防止 NaN 出现)
        await setDoc(ref, {
            id: uid, nick: nick, pw: pw,
            xp: 0, diamond: 0, 
            usedCodes: [], // 功能 7: 记录已领取的兑换码
            lastSupply: 0, // 功能 5: 补给冷却时间戳
            cycleDay: 0,   // 功能 5: 7日补给循环计数
            regTime: serverTimestamp()
        });
        alert("协议同步成功：请使用该凭据登录");
    },

    // 核心登录验证
    handleLogin: async () => {
        const uid = document.getElementById('in-uid').value.trim();
        const pw = document.getElementById('in-pw').value;
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);

        if(snap.exists() && snap.data().pw === pw) {
            const userData = { id: uid, nick: snap.data().nick };
            localStorage.setItem('SURVIVAL_USER', JSON.stringify(userData));
            location.reload();
        } else {
            alert("身份验证失败：UID 或密码错误");
        }
    },

    // 退出登录
    logout: () => {
        localStorage.removeItem('SURVIVAL_USER');
        location.reload();
    },

    // 功能 9: 改名逻辑
    changeNick: async () => {
        const newNick = prompt("请输入新的核心识别名 (昵称):");
        if(newNick && State.user) {
            await updateDoc(doc(db, "users", State.user.id), { nick: newNick });
            State.user.nick = newNick;
            localStorage.setItem('SURVIVAL_USER', JSON.stringify(State.user));
            alert("昵称重构成功，即将刷新同步");
            location.reload();
        }
    }
};

/* ============================================================
   SECTION 3: 加密通讯系统 (功能 2 & 3: 私信与全服聊天)
   ============================================================ */
window.Social = {
    // 开启通讯录：搜索玩家以发起私信
    openContacts: async () => {
        UI.toggle('f-modal'); // 假设 HTML 中已有 f-modal
        const targetId = prompt("输入对方玩家 UID 建立通讯链路:");
        if(!targetId) return;

        const snap = await getDoc(doc(db, "users", targetId));
        if(snap.exists()) {
            Social.initiatePrivateChat(targetId, snap.data().nick);
        } else {
            alert("未能在数据库中检索到该 UID 频率");
        }
    },

    // 发起私信频道 (核心功能 2)
    initiatePrivateChat: (targetId, targetNick) => {
        // 生成唯一的对话频道 ID (UID 排序拼接，确保两人在同一频道)
        const chatId = [State.user.id, targetId].sort().join("_");
        State.activeChat = chatId;
        
        // 此处应激活 UI 悬浮窗或模态框，下面演示监听逻辑
        const q = query(
            collection(db, "messages"), 
            where("chatId", "==", chatId), 
            orderBy("time", "asc"), 
            limit(50)
        );

        onSnapshot(q, (sn) => {
            console.log(`--- [私信] 与 ${targetNick} 的加密数据传输中 ---`);
            sn.forEach(d => {
                // 在 UI 中渲染消息
            });
        });
    },

    // 全服广播逻辑 (核心功能 3)
    loadGlobalChat: () => {
        const q = query(collection(db, "global_chat"), orderBy("time", "asc"), limit(100));
        onSnapshot(q, (sn) => {
            const chatBox = document.getElementById('global-msgs-area');
            if(!chatBox) return;
            chatBox.innerHTML = '';
            sn.forEach(d => {
                const msg = d.data();
                chatBox.innerHTML += `<div class="msg-line"><b>${msg.sender}:</b> ${msg.content}</div>`;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    }
};

/* ============================================================
   SECTION 4: 物资同步协议 (功能 5: 每日补给明细)
   ============================================================ */
window.Supply = {
    // 7日循环补给明细表 (功能 5 要求写出每天的补给)
    schedule: [
        { name: "木头", amount: 64, id: "wood" },   // DAY 1
        { name: "石头", amount: 64, id: "stone" },  // DAY 2
        { name: "铁锭", amount: 32, id: "iron" },   // DAY 3
        { name: "金锭", amount: 16, id: "gold" },   // DAY 4
        { name: "钻石", amount: 8, id: "diamond" },  // DAY 5
        { name: "月石", amount: 2, id: "moonstone"},// DAY 6
        { name: "核心经验", amount: 1000, id: "xp" } // DAY 7
    ],

    claim: async () => {
        if(!State.user) return;
        const ref = doc(db, "users", State.user.id);
        const snap = await getDoc(ref);
        const data = snap.data();
        const now = Date.now();

        // 24小时冷却检查
        if(now - (data.lastSupply || 0) < 86400000) {
            const wait = Math.round((86400000 - (now - data.lastSupply)) / 3600000);
            return alert(`协议冷却中：尚需等待约 ${wait} 小时才能再次同步资源`);
        }

        const currentDayIndex = (data.cycleDay || 0) % 7;
        const reward = Supply.schedule[currentDayIndex];

        // 构造更新数据
        const updateData = {
            lastSupply: now,
            cycleDay: increment(1)
        };
        
        if(reward.id === 'xp') {
            updateData.xp = increment(reward.amount);
        } else {
            // 假设 resources 是玩家的对象存储
            updateData[`resources.${reward.id}`] = increment(reward.amount);
        }

        await updateDoc(ref, updateData);
        alert(`[同步成功] 已获取 DAY ${currentDayIndex + 1} 物资: ${reward.name} x ${reward.amount}`);
    }
};
  /* ============================================================
   SECTION 5: 全球交易所协议 (功能 6: 上下架、议价沟通、实时广场)
   ============================================================ */
window.Economy = {
    // 渲染交易所广场
    loadMarket: () => {
        UI.toggle('market-modal');
        const q = query(collection(db, "market"), orderBy("time", "desc"));
        
        onSnapshot(q, (sn) => {
            const list = document.getElementById('market-list-area');
            if(!list) return;
            list.innerHTML = '';
            
            sn.forEach(d => {
                const item = d.data();
                const isMine = item.sellerId === State.user.id;
                
                // 构造列表 HTML
                list.innerHTML += `
                    <div class="f-item" style="border: 1px solid ${isMine ? 'var(--neon-green)' : '#1a3a4a'}; margin-bottom:10px; background:rgba(0,0,0,0.5)">
                        <div style="text-align:left">
                            <span style="color:var(--neon-blue); font-weight:bold;">${item.itemName}</span>
                            <br><small style="color:#888;">卖家: ${item.sellerNick} | 标价: ${item.price} XP</small>
                        </div>
                        <div>
                            ${isMine ? 
                                `<button class="btn" style="border-color:var(--neon-red); color:var(--neon-red); padding:5px 10px;" onclick="Economy.delItem('${d.id}')">终止上架</button>` : 
                                `<button class="btn" style="padding:5px 10px;" onclick="Social.initiatePrivateChat('${item.sellerId}', '${item.sellerNick}')">议价/沟通</button>`
                            }
                        </div>
                    </div>`;
            });
        });
    },

    // 物品上架协议：确保上架后全服可见
    listItem: async () => {
        const name = document.getElementById('m-item-name').value.trim();
        const price = parseInt(document.getElementById('m-item-price').value);
        
        if(!name || isNaN(price)) return alert("报文错误：物品名称或价格非法");

        await addDoc(collection(db, "market"), {
            sellerId: State.user.id,
            sellerNick: State.user.nick,
            itemName: name,
            price: price,
            time: serverTimestamp(),
            status: "ACTIVE"
        });

        // 功能 1 所需：记录行为日志
        await Logger.log(`在交易所上架了 [${name}]，定价 ${price} XP`);
        alert("协议已接入交易所：全服玩家现在可见您的条目");
        
        // 清空输入框
        document.getElementById('m-item-name').value = '';
        document.getElementById('m-item-price').value = '';
    },

    // 撤回上架 (下架)
    delItem: async (docId) => {
        if(confirm("确定终止该交易协议并下架物资？")) {
            await deleteDoc(doc(db, "market", docId));
            await Logger.log(`撤回了交易所物品: ${docId}`);
        }
    }
};

/* ============================================================
   SECTION 6: 密匙兑换中心 (功能 7: 奖励发放、后台兑换审计)
   ============================================================ */
window.Gifts = {
    // 密匙映射表
    registry: {
        "IKUN666": { diamond: 30, xp: 0, desc: "IKUN 专属福利" },
        "生存法则": { diamond: 10, xp: 500, desc: "官方庆典" },
        "第一个登陆": { diamond: 20, xp: 100, desc: "开拓者奖励" }
    },

    // 执行兑换
    redeem: async () => {
        const input = document.getElementById('gift-code-input').value.trim();
        if(!Gifts.registry[input]) return alert("校验失败：无效的密匙协议");

        const uRef = doc(db, "users", State.user.id);
        const snap = await getDoc(uRef);
        const used = snap.data().usedCodes || [];

        if(used.includes(input)) return alert("重复激活：该 ID 已经领取过此协议奖励");

        const reward = Gifts.registry[input];
        
        // 更新玩家数据
        await updateDoc(uRef, {
            diamond: increment(reward.diamond),
            xp: increment(reward.xp),
            usedCodes: [...used, input]
        });

        // 功能 1 & 7: 记录到全局审计日志，方便管理员查看谁领了什么
        await addDoc(collection(db, "audit_gifts"), {
            uid: State.user.id,
            nick: State.user.nick,
            code: input,
            reward: reward,
            timestamp: serverTimestamp()
        });

        await Logger.log(`激活了兑换码 [${input}]`);
        alert(`激活成功！已注入 ${reward.diamond} 钻石 / ${reward.xp} XP`);
    }
};

/* ============================================================
   SECTION 7: 管理员 ROOT 控制台 (功能 1: 行为日志导出、全服监控)
   ============================================================ */
window.Logger = {
    // 通用日志记录接口
    log: async (actionText) => {
        if(!State.user) return;
        try {
            await addDoc(collection(db, "action_logs"), {
                uid: State.user.id,
                nick: State.user.nick,
                action: actionText,
                time: serverTimestamp(),
                device: navigator.platform
            });
        } catch(e) { console.error("日志写入失败", e); }
    },

    // 功能 1: 导出所有行为日志为文本 (TXT)
    exportLogs: async () => {
        if(!State.isAdmin) return alert("权限拒绝：您不具备 ROOT 导出权限");
        
        alert("正在从 Firebase 高级加密接口检索最近 1000 条行为报文...");
        
        const q = query(collection(db, "action_logs"), orderBy("time", "desc"), limit(1000));
        const sn = await getDocs(q);
        
        let logContent = `[生存法则] 核心行为审计报告\n生成时间: ${new Date().toLocaleString()}\n导出者: ${State.user.nick}\n`;
        logContent += `================================================================\n\n`;

        sn.forEach(doc => {
            const l = doc.data();
            const t = l.time ? l.time.toDate().toLocaleString() : "时间戳丢失";
            logContent += `[${t}] 玩家: ${l.nick}(${l.uid}) -> 执行: ${l.action}\n`;
        });

        // 触发浏览器下载
        const blob = new Blob([logContent], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `RULES_AUDIT_${Date.now()}.txt`;
        link.click();
    },

    // 功能 7: 后台直接查看谁兑换了礼包
    viewGiftAudit: async () => {
        if(!State.isAdmin) return alert("权限拒绝");
        const q = query(collection(db, "audit_gifts"), orderBy("timestamp", "desc"), limit(100));
        const sn = await getDocs(q);
        
        let result = "--- 兑换记录实时摘要 ---\n";
        sn.forEach(d => {
            const data = d.data();
            result += `${data.nick}: ${data.code}\n`;
        });
        alert(result);
    }
};          
            /* ============================================================
   SECTION 8: 加密私信渲染引擎 (功能 2: 解决私聊点不进去的 Bug)
   ============================================================ */
window.Social = {
    ...window.Social, // 继承之前的搜索逻辑

    // 核心：打开私聊窗口并挂载实时监听
    initiatePrivateChat: (targetId, targetNick) => {
        // 生成唯一频道 ID (保证两人在同一房间)
        const chatId = [State.user.id, targetId].sort().join("_");
        State.activeChat = chatId;

        // 1. 显示私聊悬浮窗 (如果 HTML 中没有，下面代码会动态生成)
        let chatWin = document.getElementById('p-chat-window');
        if(!chatWin) {
            Social.createChatUI();
            chatWin = document.getElementById('p-chat-window');
        }
        chatWin.style.display = 'flex';
        document.getElementById('p-title').innerText = `通道: ${targetNick}`;

        // 2. 挂载 Firebase 实时监听
        const q = query(
            collection(db, "messages"), 
            where("chatId", "==", chatId), 
            orderBy("time", "asc"), 
            limit(100)
        );

        // 清除旧的监听 (如果有的话)
        if(window.unsubscribeChat) window.unsubscribeChat();

        window.unsubscribeChat = onSnapshot(q, (sn) => {
            const box = document.getElementById('p-chat-msgs');
            box.innerHTML = '';
            sn.forEach(d => {
                const m = d.data();
                const isMe = m.senderId === State.user.id;
                box.innerHTML += `
                    <div style="text-align:${isMe?'right':'left'}; margin-bottom:12px;">
                        <div style="font-size:10px; color:var(--neon-blue); opacity:0.7;">${m.senderNick}</div>
                        <div style="display:inline-block; padding:8px 12px; background:${isMe?'rgba(0,242,255,0.15)':'#111'}; 
                             border:1px solid ${isMe?'var(--neon-blue)':'#333'}; color:#fff; max-width:80%; 
                             clip-path: polygon(5px 0, 100% 0, 100% calc(100% - 5px), calc(100% - 5px) 100%, 0 100%, 0 5px);">
                            ${m.text}
                        </div>
                    </div>`;
            });
            box.scrollTop = box.scrollHeight;
        });

        // 3. 绑定发送按钮
        document.getElementById('p-send-btn').onclick = async () => {
            const inp = document.getElementById('p-m-in');
            if(!inp.value.trim()) return;
            const text = inp.value;
            inp.value = '';
            await addDoc(collection(db, "messages"), {
                chatId: State.activeChat,
                senderId: State.user.id,
                senderNick: State.user.nick,
                text: text,
                time: serverTimestamp()
            });
        };
    },

    // 动态生成私聊 UI (防止 HTML 缺失导致点不进去)
    createChatUI: () => {
        const div = document.createElement('div');
        div.id = 'p-chat-window';
        div.style.cssText = `display:none; position:fixed; bottom:20px; right:20px; width:350px; height:500px; 
                             background:#050d16; border:2px solid var(--neon-blue); flex-direction:column; z-index:9999;
                             box-shadow: 0 0 30px rgba(0,242,255,0.2);`;
        div.innerHTML = `
            <div style="padding:12px; background:rgba(0,242,255,0.1); border-bottom:1px solid var(--neon-blue); display:flex; justify-content:space-between;">
                <span id="p-title" style="font-family:Orbitron; font-size:12px; color:var(--neon-blue);">通道连接中...</span>
                <button onclick="document.getElementById('p-chat-window').style.display='none'" style="background:none; border:none; color:#fff; cursor:pointer;">✕</button>
            </div>
            <div id="p-chat-msgs" style="flex:1; overflow-y:auto; padding:15px; background:rgba(0,0,0,0.4);"></div>
            <div style="padding:10px; display:flex; gap:5px; background:#000;">
                <input id="p-m-in" placeholder="输入传输密文..." style="flex:1; margin:0; padding:8px; border:1px solid #222;">
                <button id="p-send-btn" class="btn" style="margin:0; padding:5px 15px;">发送</button>
            </div>`;
        document.body.appendChild(div);
    }
};

/* ============================================================
   SECTION 9: 荣誉榜单渲染 (功能 4: 修复 NaN 并增加美化效果)
   ============================================================ */
window.Economy = {
    ...window.Economy,
    loadRanks: () => {
        UI.toggle('rank-modal');
        // 按照 XP 降序排列前 20 名
        const q = query(collection(db, "users"), orderBy("xp", "desc"), limit(20));
        onSnapshot(q, (sn) => {
            const container = document.getElementById('rank-list-content');
            if(!container) return;
            let html = `<div style="padding:10px;">`;
            let rank = 1;
            sn.forEach(d => {
                const u = d.data();
                const xpValue = u.xp || 0; // 彻底修复 NaN
                const isTop3 = rank <= 3;
                html += `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; 
                                border-bottom:1px solid #111; background:${isTop3?'rgba(0,242,255,0.05)':'transparent'}">
                        <span style="font-family:Orbitron; color:${isTop3?'var(--neon-blue)':'#555'}; font-size:18px; width:40px;">#${rank++}</span>
                        <span style="flex:1; text-align:left; padding-left:15px;">${u.nick} <small style="color:#444;">ID:${u.id}</small></span>
                        <span style="font-family:JetBrains Mono; color:var(--neon-green); font-weight:bold;">${xpValue.toLocaleString()} XP</span>
                    </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        });
    }
};

/* ============================================================
   SECTION 10: 生存档案 Wiki (功能 8: 玩法介绍与管理团队)
   ============================================================ */
window.Wiki = {
    render: () => {
        UI.toggle('wiki-modal');
        const container = document.getElementById('wiki-content');
        if(!container) return;
        container.innerHTML = `
            <div style="text-align:left; line-height:1.8; font-size:14px; color:#ccc;">
                <h3 style="color:var(--neon-blue); font-family:Orbitron;">// 服务器架构档案</h3>
                <p>欢迎来到生存法则 (SURVIVAL RULES)。本网站为服务器核心数据交换协议端，用于玩家间的资源公示、信用排名及加密通讯。</p>
                <hr style="border:0; border-top:1px solid #222; margin:15px 0;">
                <h4 style="color:var(--neon-blue);">● 权力架构</h4>
                <ul style="list-style:none; padding-left:0;">
                    <li><b style="color:var(--neon-red);">[ROOT] 腐竹:</b> IKUN5556</li>
                    <li><b style="color:var(--neon-red);">[DEV] 创建者:</b> Peter_YT_Bilibili</li>
                    <li><b style="color:var(--neon-blue);">[ADMIN] 管理员:</b> CS||STEVE, 焦糖猫</li>
                </ul>
                <h4 style="color:var(--neon-blue);">● 生存协议</h4>
                <ol>
                    <li><b>交易所:</b> 仅作为信息发布平台，实际物资交换请在游戏内根据私聊约定完成。</li>
                    <li><b>XP 荣誉:</b> 网站 XP 代表玩家在社区的活跃度与贡献，不直接等同于游戏内物资。</li>
                    <li><b>每日补给:</b> 遵循 24 小时冷却协议，连续同步可获得更高级物资。</li>
                </ol>
            </div>`;
    }
};
            <div id="market-modal" class="modal">
    <div class="modal-content" style="width: 700px;">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">全球交易所广场</h2>
        <div style="background:rgba(0,242,255,0.05); padding:20px; margin-bottom:20px; border:1px solid #1a3a4a;">
            <div style="display:flex; gap:10px;">
                <input id="m-item-name" placeholder="物资名称 (如: 附魔金苹果)" style="flex:2; margin:0;">
                <input id="m-item-price" type="number" placeholder="标价 (XP)" style="flex:1; margin:0;">
                <button class="btn" onclick="Economy.listItem()">接入上架</button>
            </div>
        </div>
        <div id="market-list-area" style="max-height: 400px; overflow-y: auto;">
            </div>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">关闭终端</button>
    </div>
</div>

<div id="rank-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">XP 荣誉贡献排行</h2>
        <div id="rank-list-content" style="max-height: 500px; overflow-y: auto;">
            </div>
        <button class="btn" style="margin-top:20px;" onclick="UI.close()">返回</button>
    </div>
</div>

<div id="supply-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">资源同步协议</h2>
        <div id="supply-status" style="margin:20px 0; color:#888; font-size:14px;">
            当前循环：木(64) > 石(64) > 铁(32) > 金(16) > 钻(8) > 月(2) > 1000XP
        </div>
        <button class="btn" style="width:100%; padding:20px;" onclick="Supply.claim()">同步今日物资</button>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">取消</button>
    </div>
</div>

<div id="gift-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">密匙奖励激活</h2>
        <input id="gift-code-input" placeholder="输入 8 位协议密匙">
        <button class="btn" style="width:100%;" onclick="Gifts.redeem()">执行激活</button>
        <div style="margin-top:15px; font-size:11px; color:#555;">已知协议: IKUN666, 生存法则, 第一个登陆</div>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">返回</button>
    </div>
</div>

<div id="wiki-modal" class="modal">
    <div class="modal-content">
        <div id="wiki-content"></div>
        <button class="btn" style="margin-top:20px;" onclick="UI.close()">确认已知</button>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-red);">ROOT 核心审计</h2>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn" style="border-color:var(--neon-red);" onclick="Logger.exportLogs()">导出行为日志 (TXT)</button>
            <button class="btn" style="border-color:var(--neon-red);" onclick="Logger.viewGiftAudit()">查看兑换审计</button>
            <button class="btn" style="border-color:var(--neon-red);" onclick="Admin.clearMarket()">一键重置市场</button>
            <button class="btn" style="border-color:var(--neon-red);" onclick="Admin.remoteModifyXP()">远程注能 XP</button>
        </div>
        <button class="btn" style="margin-top:20px;" onclick="UI.close()">安全退出</button>
    </div>
</div>

<div id="f-modal" class="modal">
    <div class="modal-content">
        <h2 style="font-family:Orbitron; color:var(--neon-blue);">通讯录检索</h2>
        <input id="search-uid" placeholder="输入目标 UID 建立波段">
        <button class="btn" style="width:100%;" onclick="Social.searchAndChat()">搜索并私聊协议</button>
        <button class="btn" style="margin-top:20px; border-color:#444;" onclick="UI.close()">关闭</button>
    </div>
</div>

<script type="module">
/* ============================================================
   SECTION 12: 账户注销与高级管理指令 (功能 9 & 功能 1 补全)
   ============================================================ */

window.Admin = {
    // 强制清空交易所 (Admin Only)
    clearMarket: async () => {
        if(!State.isAdmin) return;
        if(confirm("警告：此操作将永久抹除交易所所有挂单，是否继续？")) {
            const sn = await getDocs(collection(db, "market"));
            sn.forEach(async d => await deleteDoc(doc(db, "market", d.id)));
            alert("交易所协议已重置");
        }
    },
    // 远程修改 XP
    remoteModifyXP: async () => {
        const tid = prompt("输入目标 UID:");
        const val = parseInt(prompt("输入注能数值 (正数为加，负数为减):"));
        if(tid && !isNaN(val)) {
            await updateDoc(doc(db, "users", tid), { xp: increment(val) });
            alert("注能成功");
        }
    }
};

window.Auth = {
    ...window.Auth,
    // 功能 9: 账户销毁协议
    terminateAccount: async () => {
        if(confirm("危险：账户销毁将永久删除云端所有资源及 XP 记录，且不可撤销！确认执行？")) {
            const pw = prompt("请输入验证密码以确认销毁:");
            const ref = doc(db, "users", State.user.id);
            const snap = await getDoc(ref);
            if(snap.exists() && snap.data().pw === pw) {
                await deleteDoc(ref);
                alert("协议已彻底销毁");
                Auth.logout();
            } else {
                alert("验证失败");
            }
        }
    }
};

// 全服聊天 UI 挂载
window.UI.renderGlobalChat = () => {
    UI.toggle('global-chat-modal');
    Social.loadGlobalChat();
};

/* ============================================================
   初始化完毕：代码逻辑链已闭合
   ============================================================ */
console.log("SURVIVAL RULES CORE V2.0 // 已就绪");
</script>
